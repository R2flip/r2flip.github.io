<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>線上與查閱人數</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    .count { font-size: 2em; margin: 10px; }
  </style>
</head>
<body>
  <h1>網站統計</h1>
  <div class="count">👁️ 總查閱人數：<span id="views">-</span></div>
  <div class="count">🟢 線上人數：<span id="online">-</span></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyhWHGuDISk5686ZR4DANrxyl85dsK51NSZVH8PwO41__2aE-Vg-nhQBdYJPMEe3-lU/exec'; // ← 替換為你部署的 Apps Script 網址

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    const SESSION_KEY = 'user_session_id';
    let sessionId = localStorage.getItem(SESSION_KEY);
    if (!sessionId) {
      sessionId = generateUUID();
      localStorage.setItem(SESSION_KEY, sessionId);
    }

    function pingServer() {
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ sessionId }),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.views !== undefined) {
          document.getElementById('views').textContent = data.views;
        }
        if (data.online !== undefined) {
          document.getElementById('online').textContent = data.online;
        }
        if (data.error) {
          console.error("Server Error:", data.error);
        }
      })
      .catch(err => console.error("Fetch Error:", err));
    }

    // 初次載入和每 15 秒 ping 一次
    pingServer();
    setInterval(pingServer, 15000);
  </script>
</body>
</html>
