<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆå«é è­¦ç‡ˆè™Ÿï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ECharts + TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg1:#0b1220;
      --bg2:#0f172a;
      --card: rgba(255,255,255,0.92);
      --card2: rgba(255,255,255,0.86);
      --text:#0f172a;
      --muted:#6b7280;
      --shadow: 0 18px 45px rgba(2,6,23,.25);
      --ring: 0 0 0 3px rgba(59,130,246,.2);
      --radius: 18px;

      /* âœ… é è­¦ç³»çµ±ï¼šæ›´æ¨™æº–ã€æ›´æ¸…æ¥š */
      --green:#22c55e;   /* å®‰å…¨ */
      --yellow:#fbbf24;  /* æ³¨æ„ */
      --red:#ef4444;     /* è­¦æˆ’ */

      --blue:#2563eb;
      --pink:#ec4899;
    }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.35), transparent 55%),
        radial-gradient(1000px 550px at 100% 0%, rgba(236,72,153,.25), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(34,197,94,.18), transparent 55%),
        linear-gradient(180deg, #0b1020, #0b1220 40%, #0b1220);
      color: #e5e7eb;
      display:flex;
      flex-direction:column;
    }

    header{
      padding: 18px 22px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 18px;
      border-bottom: 1px solid rgba(148,163,184,.16);
      background: linear-gradient(90deg, rgba(15,23,42,.7), rgba(37,99,235,.25), rgba(236,72,153,.18));
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .hgroup{ display:flex; flex-direction:column; gap: 6px; }
    header h1{
      font-size: 1.25rem;
      letter-spacing: .06em;
      font-weight: 780;
      line-height: 1.25;
    }
    header .subtitle{
      font-size:.92rem;
      opacity:.9;
      color: rgba(226,232,240,.9);
    }
    .meta-right{
      text-align:right;
      font-size:.9rem;
      color: rgba(226,232,240,.85);
      display:flex;
      flex-direction:column;
      gap: 6px;
      align-items:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(148,163,184,.18);
      box-shadow: 0 8px 22px rgba(2,6,23,.15);
      color: rgba(226,232,240,.95);
      font-weight: 650;
      letter-spacing: .02em;
      white-space: nowrap;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.25));
      box-shadow: 0 0 0 2px rgba(255,255,255,.10);
    }

    main.layout{
      flex:1;
      display:flex;
      gap: 16px;
      padding: 16px 18px 18px;
      align-items: stretch;
    }

    .card{
      background: var(--card);
      color: var(--text);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,.22);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(500px 300px at 15% 0%, rgba(37,99,235,.12), transparent 60%),
                  radial-gradient(450px 260px at 100% 0%, rgba(236,72,153,.10), transparent 60%);
      pointer-events:none;
    }

    .map-panel{
      flex: 72;
      min-width: 0;
      display:flex;
      flex-direction:column;
      padding: 14px 14px 12px;
      gap: 10px;
    }

    .control-panel{
      flex: 28;
      min-width: 320px;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      padding: 10px 10px 6px;
      position:relative;
      z-index: 1;
    }
    .card-title{
      font-size: 1.05rem;
      font-weight: 780;
      color: #0b1220;
      display:flex;
      align-items:center;
      gap: 10px;
      letter-spacing: .02em;
    }
    .tag{
      font-size: .72rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37,99,235,.12), rgba(236,72,153,.12));
      border: 1px solid rgba(148,163,184,.25);
      color: #0f172a;
      font-weight: 700;
      white-space:nowrap;
    }
    .card-subtitle{
      font-size: .88rem;
      color: var(--muted);
      text-align:right;
      line-height: 1.3;
      max-width: 55%;
    }

    .card-body{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 0 10px 10px;
      position:relative;
      z-index: 1;
      min-height: 0;
    }

    #mapContainer{
      width:100%;
      flex:1;
      min-height: 560px;
      border-radius: 14px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(219,234,254,.9), rgba(243,244,246,.9));
      border: 1px solid rgba(148,163,184,.25);
    }

    #barContainer{
      width:100%;
      flex:1;
      min-height: 260px;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(249,250,251,.95);
      border: 1px solid rgba(148,163,184,.25);
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .control-group{ display:flex; flex-direction:column; gap: 6px; }
    .control-label{
      font-size: .78rem;
      color: #475569;
      font-weight: 700;
      letter-spacing: .02em;
    }
    select{
      padding: 9px 12px;
      font-size: .92rem;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(255,255,255,.92);
      outline:none;
      transition: .15s ease;
    }
    select:focus{
      border-color: rgba(37,99,235,.8);
      box-shadow: var(--ring);
      transform: translateY(-1px);
    }

    .thresholds{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding-top: 6px;
    }
    .thresholds .pill{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,.04);
      border: 1px solid rgba(148,163,184,.22);
      display:flex;
      flex-direction:column;
      gap: 4px;
    }
    .pill .p-title{
      font-size: .78rem;
      color: #0f172a;
      font-weight: 800;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .pill .p-desc{
      font-size: .75rem;
      color: #64748b;
      line-height: 1.35;
    }
    .light-chip{
      font-size: .72rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(255,255,255,.65);
      font-weight: 800;
      white-space: nowrap;
    }
    .chip-green{ color: var(--green); }
    .chip-yellow{ color: var(--yellow); }
    .chip-red{ color: var(--red); }

    .stat-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 2px;
    }
    .stat-grid.three{ grid-template-columns: 1fr 1fr 1fr; }
    .stat{
      border-radius: 14px;
      padding: 10px 12px;
      background: linear-gradient(90deg, rgba(224,242,254,.9), rgba(254,252,232,.7));
      border: 1px solid rgba(148,163,184,.25);
      display:flex;
      flex-direction:column;
      gap: 3px;
    }
    .stat .label{
      font-size: .74rem;
      color: #475569;
      font-weight: 750;
    }
    .stat .value{
      font-size: .98rem;
      color: #0f172a;
      font-weight: 850;
      letter-spacing: .02em;
    }

    .legend-note{
      font-size: .82rem;
      color: #475569;
      padding: 2px 2px 0;
      line-height: 1.45;
    }
    .footer-hint{
      margin-top: 2px;
      font-size: .78rem;
      color: #64748b;
    }

    /* âœ… ç´…ç‡ˆæ¸…å–® */
    .red-card{
      padding: 14px 14px 12px;
    }
    .red-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 0 0 8px;
      position:relative;
      z-index:1;
    }
    .btn{
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(255,255,255,.85);
      color: #0f172a;
      font-weight: 850;
      cursor: pointer;
      transition: .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 25px rgba(2,6,23,.12); }
    .btn.red{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.25);
      color: #991b1b;
    }
    #redList{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .red-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 9px 10px;
      border-radius: 14px;
      background: rgba(239,68,68,.10);
      border: 1px solid rgba(239,68,68,.22);
      font-weight: 900;
      color: #7f1d1d;
    }
    .ok-item{
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(34,197,94,.10);
      border: 1px solid rgba(34,197,94,.20);
      font-weight: 900;
      color: #166534;
    }

    @media (max-width: 980px){
      main.layout{ flex-direction: column; }
      .control-panel{ min-width: 0; }
      #mapContainer{ min-height: 460px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="hgroup">
      <h1>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆå«é è­¦ç‡ˆè™Ÿï¼‰</h1>
      <div class="subtitle">è³‡è¨Šåˆ†å±¤ï¼šç†±åŠ›åœ–ï¼ˆæŒ‡æ¨™åˆ†æ•¸ï¼‰ï¼‹ ç‡ˆè™Ÿï¼ˆé è­¦åˆ†æ•¸ï¼‰ï¼‹ Top10 èˆ‡ç‡ˆè™Ÿçµ±è¨ˆ</div>
    </div>
    <div class="meta-right">
      <div class="badge"><span class="dot"></span>è³‡æ–™ä¾†æºï¼šTCCAS æ ¡åœ’èª¿æŸ¥ã€ç·šä¸Šå•å·ï¼ˆç¤ºç¯„è³‡æ–™ï¼‰</div>
      <div class="subtitle" id="currentMeta">å¹´åº¦ï¼šâ€”ã€€ï½œã€€æŒ‡æ¨™ï¼šâ€”</div>
    </div>
  </header>

  <main class="layout">
    <!-- å·¦å´ï¼šåœ°åœ– -->
    <section class="card map-panel">
      <div class="card-header">
        <div class="card-title">
          å„ç¸£å¸‚ç†±åŠ›åœ– & é è­¦ç‡ˆè™Ÿ
          <span class="tag">ç¶  / é»ƒ / ç´… ä¸‰è‰²é è­¦</span>
        </div>
        <div class="card-subtitle" id="mapSubtitle">
          ç†±åŠ›åœ–é¡è‰²ï¼šæŒ‡æ¨™åˆ†æ•¸ï¼ˆvalueï¼‰<br/>
          åœ“é»ç‡ˆè™Ÿï¼šé è­¦åˆ†æ•¸ï¼ˆwarnï¼‰
        </div>
      </div>

      <div class="card-body">
        <div id="mapContainer"></div>
        <div class="legend-note">
          èªªæ˜ï¼šç†±åŠ›åœ–é¡è‰²è¡¨ç¤º<strong>æŒ‡æ¨™åˆ†æ•¸</strong>é«˜ä½ï¼ˆä¸­æ€§è‰²éšï¼Œé¿å…èˆ‡ç‡ˆè™Ÿæ··æ·†ï¼‰ï¼›åœ“é»é¡è‰²è¡¨ç¤º<strong>é è­¦ç‡ˆè™Ÿ</strong>ï¼ˆä¾é è­¦åˆ†æ•¸é–€æª»åˆ¤æ–·ï¼‰ã€‚æ»‘é¼ ç§»åˆ°ç¸£å¸‚å¯æŸ¥çœ‹è©³ç´°åˆ†æ•¸ã€‚
        </div>
      </div>
    </section>

    <!-- å³å´ï¼šæ§åˆ¶/çµ±è¨ˆ/Top10/ç´…ç‡ˆ -->
    <aside class="control-panel">
      <section class="card" style="padding: 14px 14px 12px;">
        <div class="card-header" style="padding: 0 0 8px;">
          <div class="card-title">åˆ†ææ¢ä»¶</div>
          <div class="card-subtitle">å¹´åº¦/æŒ‡æ¨™ + é–€æª»é¡¯ç¤º</div>
        </div>

        <div class="card-body" style="padding:0; gap: 10px;">
          <div class="controls">
            <div class="control-group">
              <label for="yearSelect" class="control-label">å¹´åº¦</label>
              <select id="yearSelect">
                <option value="2024" selected>2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
              </select>
            </div>

            <div class="control-group">
              <label for="metricSelect" class="control-label">æŒ‡æ¨™é¡å‹</label>
              <select id="metricSelect">
                <option value="mean_score" selected>å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
                <option value="high_risk_pct">ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
                <option value="severe_score">å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="thresholds">
            <div class="pill">
              <div class="p-title">
                é è­¦é–€æª»
                <span class="light-chip chip-green">ç¶ ç‡ˆ</span>
              </div>
              <div class="p-desc" id="thGreen">â€”</div>
            </div>
            <div class="pill">
              <div class="p-title">
                é¢¨éšªé–€æª»
                <span class="light-chip chip-yellow">é»ƒç‡ˆ</span>
              </div>
              <div class="p-desc" id="thYellow">â€”</div>
            </div>
          </div>

          <div class="pill" style="border-radius:14px; background: rgba(15,23,42,.04); border:1px solid rgba(148,163,184,.22); padding:10px 12px;">
            <div class="p-title" style="margin-bottom: 2px;">
              æœ€é«˜é¢¨éšª
              <span class="light-chip chip-red">ç´…ç‡ˆ</span>
            </div>
            <div class="p-desc" id="thRed">â€”</div>
            <div class="footer-hint">â€» é–€æª»å¯åœ¨ç¨‹å¼ä¸­èª¿æ•´ warnThresholds</div>
          </div>

          <div class="stat-grid">
            <div class="stat">
              <div class="label">å…¨åœ‹å¹³å‡ï¼ˆæŒ‡æ¨™åˆ†æ•¸ï¼‰</div>
              <div class="value" id="statAvg">â€”</div>
            </div>
            <div class="stat">
              <div class="label">æœ€é«˜ç¸£å¸‚ï¼ˆæŒ‡æ¨™åˆ†æ•¸ï¼‰</div>
              <div class="value" id="statMax">â€”</div>
            </div>
          </div>

          <div class="stat-grid three">
            <div class="stat">
              <div class="label">ç¶ ç‡ˆç¸£å¸‚æ•¸</div>
              <div class="value" id="statGreen">â€”</div>
            </div>
            <div class="stat">
              <div class="label">é»ƒç‡ˆç¸£å¸‚æ•¸</div>
              <div class="value" id="statYellow">â€”</div>
            </div>
            <div class="stat">
              <div class="label">ç´…ç‡ˆç¸£å¸‚æ•¸</div>
              <div class="value" id="statRed">â€”</div>
            </div>
          </div>
        </div>
      </section>

      <section class="card" style="flex:1; display:flex; flex-direction:column; padding: 14px 14px 12px;">
        <div class="card-header" style="padding: 0 0 8px;">
          <div class="card-title">Top 10 ç¸£å¸‚æ¯”è¼ƒ</div>
          <div class="card-subtitle" id="barTitle">â€”</div>
        </div>
        <div class="card-body" style="padding:0; min-height:0;">
          <div id="barContainer"></div>
          <div class="legend-note" style="padding: 6px 2px 0;">
            æ¢åœ–é¡è‰²ä¾ã€Œé è­¦ç‡ˆè™Ÿã€è‘—è‰²ï¼šç¶ ï¼é»ƒï¼ç´…ï¼ˆä»¥é è­¦åˆ†æ•¸åˆ¤æ–·ï¼‰ã€‚
          </div>
        </div>
      </section>

      <!-- âœ… ç´…ç‡ˆç¸£å¸‚æ¸…å–® + ä¸‹è¼‰ CSV -->
      <section class="card red-card">
        <div class="red-head">
          <div class="card-title">ğŸ”´ ç´…ç‡ˆç¸£å¸‚æ¸…å–®</div>
          <button id="downloadCSV" class="btn red">ä¸‹è¼‰ CSV</button>
        </div>
        <div class="card-body" style="padding:0; gap:8px;">
          <ul id="redList"></ul>
          <div class="legend-note">â€» ä¾ã€Œé è­¦åˆ†æ•¸ã€èˆ‡ç‡ˆè™Ÿé–€æª»åˆ¤å®šï¼ˆå¿ƒç†éŸŒæ€§ç‚ºåå‘ç‡ˆè™Ÿï¼‰</div>
        </div>
      </section>
    </aside>
  </main>

  <script>
    // =========================
    // 0) æª”æ¡ˆè¨­å®š
    // =========================
    const TOPO_URL = 'twCounty_22counties_topo.json'; // è‹¥ä¸åœ¨åŒä¸€å±¤è«‹æ”¹è·¯å¾‘

    // =========================
    // 1) æ¨¡æ“¬è³‡æ–™ï¼ˆç¤ºç¯„ï¼‰
    //    value: æŒ‡æ¨™åˆ†æ•¸ï¼ˆç†±åŠ›åœ–ä¸Šè‰²ï¼‰
    //    warn : é è­¦åˆ†æ•¸ï¼ˆç‡ˆè™Ÿåˆ¤æ–·ï¼Œå¯èˆ‡ value ç›¸åŒæˆ–ä¸åŒï¼‰
    // =========================
    const climateAnxietyData = {
      "2024": {
        "mean_score": [
          { name: "å°åŒ—å¸‚", value: 78, warn: 80 },
          { name: "æ–°åŒ—å¸‚", value: 72, warn: 73 },
          { name: "æ¡ƒåœ’å¸‚", value: 70, warn: 69 },
          { name: "å°ä¸­å¸‚", value: 69, warn: 68 },
          { name: "å°å—å¸‚", value: 65, warn: 64 },
          { name: "é«˜é›„å¸‚", value: 75, warn: 77 },
          { name: "åŸºéš†å¸‚", value: 68, warn: 70 },
          { name: "æ–°ç«¹å¸‚", value: 80, warn: 83 },
          { name: "å˜‰ç¾©å¸‚", value: 66, warn: 65 },
          { name: "æ–°ç«¹ç¸£", value: 77, warn: 79 },
          { name: "è‹—æ —ç¸£", value: 62, warn: 60 },
          { name: "å½°åŒ–ç¸£", value: 60, warn: 59 },
          { name: "å—æŠ•ç¸£", value: 63, warn: 61 },
          { name: "é›²æ—ç¸£", value: 58, warn: 57 },
          { name: "å˜‰ç¾©ç¸£", value: 59, warn: 58 },
          { name: "å±æ±ç¸£", value: 67, warn: 66 },
          { name: "å®œè˜­ç¸£", value: 71, warn: 72 },
          { name: "èŠ±è“®ç¸£", value: 69, warn: 70 },
          { name: "å°æ±ç¸£", value: 68, warn: 69 },
          { name: "æ¾æ¹–ç¸£", value: 61, warn: 60 },
          { name: "é‡‘é–€ç¸£", value: 55, warn: 54 },
          { name: "é€£æ±Ÿç¸£", value: 52, warn: 51 }
        ],
        "high_risk_pct": [
          { name: "å°åŒ—å¸‚", value: 26, warn: 27 },
          { name: "æ–°åŒ—å¸‚", value: 22, warn: 23 },
          { name: "é«˜é›„å¸‚", value: 24, warn: 25 },
          { name: "æ–°ç«¹å¸‚", value: 28, warn: 29 },
          { name: "æ–°ç«¹ç¸£", value: 25, warn: 26 },
          { name: "å°ä¸­å¸‚", value: 21, warn: 21 },
          { name: "å±æ±ç¸£", value: 20, warn: 20 },
          { name: "å®œè˜­ç¸£", value: 23, warn: 24 },
          { name: "èŠ±è“®ç¸£", value: 22, warn: 22 },
          { name: "å°æ±ç¸£", value: 21, warn: 21 },
          { name: "å°å—å¸‚", value: 19, warn: 19 },
          { name: "å˜‰ç¾©å¸‚", value: 18, warn: 18 }
        ],
        "severe_score": [
          { name: "å°åŒ—å¸‚", value: 84, warn: 82 },
          { name: "æ–°åŒ—å¸‚", value: 81, warn: 79 },
          { name: "æ¡ƒåœ’å¸‚", value: 79, warn: 77 },
          { name: "å°ä¸­å¸‚", value: 78, warn: 76 },
          { name: "é«˜é›„å¸‚", value: 85, warn: 83 },
          { name: "æ–°ç«¹å¸‚", value: 86, warn: 84 },
          { name: "æ–°ç«¹ç¸£", value: 83, warn: 81 },
          { name: "å±æ±ç¸£", value: 80, warn: 78 },
          { name: "å®œè˜­ç¸£", value: 82, warn: 80 },
          { name: "èŠ±è“®ç¸£", value: 81, warn: 79 },
          { name: "å°æ±ç¸£", value: 80, warn: 78 }
        ]
      },
      "2023": { "mean_score": [], "high_risk_pct": [], "severe_score": [] },
      "2022": { "mean_score": [], "high_risk_pct": [], "severe_score": [] }
    };

    // =========================
    // 2) é è­¦é–€æª»ï¼ˆå¯ä¾æŒ‡æ¨™èª¿æ•´ï¼‰
    //    (å¿ƒç†éŸŒæ€§ severe_score ç‚ºåå‘ç‡ˆè™Ÿï¼šé«˜åˆ†=ç¶ ç‡ˆ)
    // =========================
    const warnThresholds = {
      mean_score:    { greenMax: 65, yellowMax: 75 },
      high_risk_pct: { greenMax: 20, yellowMax: 25 },
      severe_score:  { greenMax: 72, yellowMax: 82 }
    };

    function getLight(metric, warnScore){
      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };

      // âœ… å¿ƒç†éŸŒæ€§ï¼šåˆ†æ•¸è¶Šé«˜è¶Šå¥½ï¼ˆåå‘ç‡ˆè™Ÿï¼‰
      if (metric === "severe_score") {
        if (warnScore >= t.yellowMax) return "green";
        if (warnScore >= t.greenMax) return "yellow";
        return "red";
      }

      // âœ… å…¶ä»–ï¼šåˆ†æ•¸è¶Šé«˜è¶Šå±éšª
      if (warnScore <= t.greenMax) return "green";
      if (warnScore <= t.yellowMax) return "yellow";
      return "red";
    }

    function lightText(light){
      return light === "green" ? "ç¶ ç‡ˆ" : light === "yellow" ? "é»ƒç‡ˆ" : "ç´…ç‡ˆ";
    }
    function lightColor(light){
      return light === "green" ? "#22c55e" : light === "yellow" ? "#fbbf24" : "#ef4444";
    }

    function metricLabel(metric){
      return ({
        mean_score: "å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        high_risk_pct: "ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        severe_score: "å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰"
      })[metric] || metric;
    }

    // =========================
    // 3) åˆå§‹åŒ–åœ–è¡¨ + DOM
    // =========================
    const mapChart = echarts.init(document.getElementById('mapContainer'));
    const barChart = echarts.init(document.getElementById('barContainer'));

    const yearSelect = document.getElementById('yearSelect');
    const metricSelect = document.getElementById('metricSelect');

    const currentMeta = document.getElementById('currentMeta');
    const barTitle = document.getElementById('barTitle');

    const statAvg = document.getElementById('statAvg');
    const statMax = document.getElementById('statMax');
    const statGreen = document.getElementById('statGreen');
    const statYellow = document.getElementById('statYellow');
    const statRed = document.getElementById('statRed');

    const thGreen = document.getElementById('thGreen');
    const thYellow = document.getElementById('thYellow');
    const thRed = document.getElementById('thRed');

    const redList = document.getElementById('redList');
    const downloadCSV = document.getElementById('downloadCSV');

    let taiwanGeoJson = null;
    let countyCentroid = new Map(); // name -> [lng,lat]

    // =========================
    // 4) å¹¾ä½•ï¼šè¨ˆç®— centroidï¼ˆæ‰“é»ï¼‰+ æœ¬å³¶ bboxï¼ˆè‡ªå‹• fitï¼‰
    // =========================
    function centroidOfPolygon(coords){
      const ring = coords?.[0];
      if (!ring || ring.length < 3) return null;
      let area = 0, cx = 0, cy = 0;
      for (let i = 0; i < ring.length - 1; i++){
        const [x1,y1] = ring[i];
        const [x2,y2] = ring[i+1];
        const a = x1*y2 - x2*y1;
        area += a;
        cx += (x1 + x2) * a;
        cy += (y1 + y2) * a;
      }
      area *= 0.5;
      if (Math.abs(area) < 1e-10) return ring[0];
      cx /= (6*area);
      cy /= (6*area);
      return [cx, cy];
    }

    function centroidOfGeometry(geom){
      if (!geom) return null;
      if (geom.type === "Polygon") return centroidOfPolygon(geom.coordinates);
      if (geom.type === "MultiPolygon"){
        let best = null, bestArea = -Infinity;
        for (const poly of geom.coordinates){
          const ring = poly?.[0];
          if (!ring || ring.length < 3) continue;
          let area = 0;
          for (let i=0;i<ring.length-1;i++){
            const [x1,y1]=ring[i], [x2,y2]=ring[i+1];
            area += (x1*y2 - x2*y1);
          }
          const absA = Math.abs(area * 0.5);
          if (absA > bestArea){
            bestArea = absA;
            best = centroidOfPolygon(poly);
          }
        }
        return best;
      }
      return null;
    }

    function buildCentroids(geoJson){
      countyCentroid.clear();
      for (const f of geoJson.features || []){
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        const c = centroidOfGeometry(f.geometry);
        if (name && c) countyCentroid.set(name, c);
      }
    }

    function getCountyCoord(countyName){
      return countyCentroid.get(countyName) || null;
    }

    // âœ… æœ¬å³¶ bboxï¼šæ’é™¤é›¢å³¶é¿å…è¦–é‡è¢«æ‹‰æ­ª
    const EXCLUDE_COUNTIES = new Set(["æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"]);
    let MAIN_ISLAND_BBOX = null; // [[minLng,minLat],[maxLng,maxLat]]

    function expandBbox(b, x, y) {
      if (!b) return { minX: x, minY: y, maxX: x, maxY: y };
      return {
        minX: Math.min(b.minX, x),
        minY: Math.min(b.minY, y),
        maxX: Math.max(b.maxX, x),
        maxY: Math.max(b.maxY, y)
      };
    }

    function bboxOfCoords(coords, bbox) {
      if (!coords) return bbox;
      if (typeof coords[0] === "number") return expandBbox(bbox, coords[0], coords[1]);
      for (const c of coords) bbox = bboxOfCoords(c, bbox);
      return bbox;
    }

    function computeMainIslandBoundingCoords(geoJson) {
      let bbox = null;
      for (const f of (geoJson.features || [])) {
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        if (EXCLUDE_COUNTIES.has(name)) continue;
        bbox = bboxOfCoords(f.geometry?.coordinates, bbox);
      }
      if (!bbox) return null;
      return [[bbox.minX, bbox.minY], [bbox.maxX, bbox.maxY]];
    }

    // =========================
    // 5) è¼‰å…¥åœ°åœ– + é¦–æ¬¡ç¹ªè£½
    // =========================
    fetch(TOPO_URL)
      .then(res => res.json())
      .then(topoData => {
        const objKey = topoData.objects && (topoData.objects.layer1 ? "layer1" : Object.keys(topoData.objects)[0]);
        const geo = topojson.feature(topoData, topoData.objects[objKey]);
        taiwanGeoJson = geo;

        buildCentroids(geo);
        MAIN_ISLAND_BBOX = computeMainIslandBoundingCoords(geo);

        echarts.registerMap('taiwan', geo);
        updateCharts();
      })
      .catch(err => {
        console.error('è¼‰å…¥ TopoJSON å¤±æ•—ï¼š', err);
        alert('è«‹ç¢ºèª twCounty_22counties_topo.json è·¯å¾‘æ­£ç¢ºï¼Œä¸”ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿã€‚');
      });

    yearSelect.addEventListener('change', updateCharts);
    metricSelect.addEventListener('change', updateCharts);

    // =========================
    // 6) CSV ä¸‹è¼‰ï¼ˆç´…ç‡ˆç¸£å¸‚ï¼‰
    // =========================
    downloadCSV.addEventListener('click', () => {
      const year = yearSelect.value;
      const metric = metricSelect.value;
      const metricText = metricLabel(metric);

      const rows = [["å¹´åº¦","ç¸£å¸‚","æŒ‡æ¨™é¡å‹","æŒ‡æ¨™åˆ†æ•¸","é è­¦åˆ†æ•¸","ç‡ˆè™Ÿ"]];
      const raw = climateAnxietyData[year]?.[metric] || [];

      raw.forEach(d => {
        const warnScore = d.warn ?? d.value;
        const light = getLight(metric, warnScore);
        if (light === "red") {
          rows.push([year, d.name, metricText, d.value, warnScore, "ç´…ç‡ˆ"]);
        }
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${year}_${metric}_ç´…ç‡ˆç¸£å¸‚æ¸…å–®.csv`;
      a.click();

      URL.revokeObjectURL(url);
    });

    // =========================
    // 7) æ›´æ–°ä¸»å‡½å¼
    // =========================
    function updateCharts(){
      const year = yearSelect.value;
      const metric = metricSelect.value;

      const metricText = metricLabel(metric);
      currentMeta.textContent = `å¹´åº¦ï¼š${year}ã€€ï½œã€€æŒ‡æ¨™ï¼š${metricText}`;
      barTitle.textContent = `${year} å¹´ ${metricText} Top 10ï¼ˆç‡ˆè™Ÿä¾é è­¦åˆ†æ•¸ï¼‰`;

      // é–€æª»é¡¯ç¤º
      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };
      if (metric === "severe_score") {
        thGreen.textContent  = `é è­¦åˆ†æ•¸ â‰¥ ${t.yellowMax} ç‚º ç¶ ç‡ˆï¼ˆå¿ƒç†éŸŒæ€§é«˜ï¼‰`;
        thYellow.textContent = `é è­¦åˆ†æ•¸ ${t.greenMax} ï½ ${t.yellowMax - 0.1} ç‚º é»ƒç‡ˆï¼ˆä¸­ç­‰éŸŒæ€§ï¼‰`;
        thRed.textContent    = `é è­¦åˆ†æ•¸ < ${t.greenMax} ç‚º ç´…ç‡ˆï¼ˆå¿ƒç†éŸŒæ€§ä¸è¶³ï¼‰`;
      } else {
        thGreen.textContent  = `é è­¦åˆ†æ•¸ â‰¤ ${t.greenMax} ç‚º ç¶ ç‡ˆï¼ˆä½é¢¨éšªï¼‰`;
        thYellow.textContent = `é è­¦åˆ†æ•¸ ${t.greenMax + 0.1} ï½ ${t.yellowMax} ç‚º é»ƒç‡ˆï¼ˆæ³¨æ„ï¼‰`;
        thRed.textContent    = `é è­¦åˆ†æ•¸ > ${t.yellowMax} ç‚º ç´…ç‡ˆï¼ˆé«˜é¢¨éšªï¼‰`;
      }

      const raw = climateAnxietyData[year]?.[metric] || [];
      if (!raw.length){
        mapChart.clear();
        barChart.clear();
        statAvg.textContent = 'ç„¡è³‡æ–™';
        statMax.textContent = 'ç„¡è³‡æ–™';
        statGreen.textContent = 'â€”';
        statYellow.textContent = 'â€”';
        statRed.textContent = 'â€”';
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡è³‡æ–™</li>`;
        return;
      }

      const enriched = raw.map(d => {
        const warnScore = (d.warn ?? d.value);
        const light = getLight(metric, warnScore);
        return { ...d, warnScore, light };
      });

      // çµ±è¨ˆï¼ˆæŒ‡æ¨™åˆ†æ•¸ï¼‰
      const values = enriched.map(d => d.value);
      const avg = values.reduce((a,b)=>a+b,0) / values.length;
      const maxVal = Math.max(...values);
      const maxItem = enriched.find(d => d.value === maxVal);

      statAvg.textContent = `${avg.toFixed(1)} åˆ†`;
      statMax.textContent = `${maxItem.name}ï¼š${maxItem.value.toFixed(1)} åˆ†`;

      // ç‡ˆè™Ÿæ•¸é‡ï¼ˆé è­¦åˆ†æ•¸ï¼‰
      const greenCount = enriched.filter(d => d.light === "green").length;
      const yellowCount = enriched.filter(d => d.light === "yellow").length;
      const redCount = enriched.filter(d => d.light === "red").length;

      statGreen.textContent = `${greenCount} ç¸£å¸‚`;
      statYellow.textContent = `${yellowCount} ç¸£å¸‚`;
      statRed.textContent = `${redCount} ç¸£å¸‚`;

      // âœ… ç´…ç‡ˆæ¸…å–®
      const redItems = enriched.filter(d => d.light === "red");
      redList.innerHTML = "";
      if (!redItems.length) {
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡ç´…ç‡ˆç¸£å¸‚</li>`;
      } else {
        redItems
          .sort((a,b)=> b.warnScore - a.warnScore)
          .forEach(d => {
            const li = document.createElement('li');
            li.className = "red-item";
            li.innerHTML = `<span>${d.name}</span><span>${d.warnScore.toFixed(1)}</span>`;
            redList.appendChild(li);
          });
      }

      // Top 10ï¼ˆä»¥æŒ‡æ¨™åˆ†æ•¸æ’åï¼‰
      const top10 = [...enriched].sort((a,b)=>b.value-a.value).slice(0,10).reverse();

      // ç‡ˆè™Ÿé»ä½ï¼ˆå»ºè­°æ’é™¤é›¢å³¶ï¼Œè¦–è¦ºæ›´èšç„¦æœ¬å³¶ï¼‰
      const lightPoints = enriched
        .filter(d => !EXCLUDE_COUNTIES.has(d.name))
        .map(d => {
          const coord = getCountyCoord(d.name);
          if (!coord) return null;
          return {
            name: d.name,
            value: [coord[0], coord[1], d.warnScore],
            light: d.light,
            metricValue: d.value,
            warnScore: d.warnScore
          };
        })
        .filter(Boolean);

      // =========================
      // 7-1) åœ°åœ–ï¼šç†±åŠ› + ç‡ˆè™Ÿç–Šå±¤
      // =========================
      const mapOption = {
        backgroundColor: 'transparent',
        geo: {
          map: 'taiwan',
          roam: true,

          // âœ… è‡ªå‹• fit æœ¬å³¶ bboxï¼ˆé—œéµï¼‰
          boundingCoords: MAIN_ISLAND_BBOX || null,
          layoutCenter: ['50%', '54%'],
          layoutSize: '98%',

          // âœ… çµ¦å³å´ visualMap ç•™ç©ºé–“
          top: 44,
          bottom: 10,
          left: 10,
          right: 64,

          aspectScale: 0.8,
          nameProperty: 'COUNTYNAME',
          itemStyle: {
            borderColor: 'rgba(148,163,184,.55)',
            borderWidth: 0.8
          },
          emphasis: {
            label: { show: true, color: '#0b1220', fontWeight: 800 },
            itemStyle: {
              borderColor: '#0b1220',
              borderWidth: 1.5,
              shadowColor: 'rgba(2,6,23,.35)',
              shadowBlur: 14
            }
          }
        },

        tooltip: {
          trigger: 'item',
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const countyName = params.name;
            const item = enriched.find(x => x.name === countyName);
            if (!item) return `<div style="font-weight:800">${countyName}</div><div>ç„¡è³‡æ–™</div>`;

            const lt = lightText(item.light);
            const lc = lightColor(item.light);

            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px;">
                  <div style="font-weight:900;color:#0b1220;font-size:14px">${countyName}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;line-height:1.45;font-size:12px">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${Number(item.value).toFixed(1)}</b> åˆ†</div>
                  <div>é è­¦åˆ†æ•¸ï¼š<b>${Number(item.warnScore).toFixed(1)}</b> åˆ†</div>
                  <div style="margin-top:6px;color:#64748b;">æç¤ºï¼šç†±åŠ›åœ–=æŒ‡æ¨™åˆ†æ•¸ï¼›ç‡ˆè™Ÿ=é è­¦åˆ†æ•¸</div>
                </div>
              </div>
            `;
          }
        },

        // âœ… å³å´ç›´å‘ visualMapï¼ˆä½œç”¨åœ¨ç†±åŠ›åœ– map seriesï¼‰
        visualMap: {
          type: 'continuous',
          show: true,
          seriesIndex: 0,
          dimension: 0,

          min: Math.min(...values),
          max: Math.max(...values),

          orient: 'vertical',
          right: 12,
          top: 74,
          bottom: 18,

          itemWidth: 12,
          itemHeight: 280,

          calculable: true,
          realtime: true,

          text: ['é«˜', 'ä½'],
          textGap: 8,
          textStyle: { color: '#334155', fontWeight: 800, fontSize: 12 },

          handleSize: 18,
          handleStyle: { color: '#334155', borderColor: '#0f172a', borderWidth: 1 },

          // âœ… ä¸­æ€§è‰²éšï¼šé¿å…èˆ‡ç‡ˆè™Ÿï¼ˆç´…é»ƒç¶ ï¼‰æ··æ·†
          inRange: {
            color: ['#eef2ff', '#c7d2fe', '#818cf8', '#312e81']
          },

          backgroundColor: 'transparent',
          borderWidth: 0,
          padding: 0
        },

        series: [
          // ç†±åŠ›å±¤ï¼šç”¨ value ä¸Šè‰²
          {
            name: metricText,
            type: 'map',
            geoIndex: 0,
            map: 'taiwan',
            roam: false,
            nameProperty: 'COUNTYNAME',
            data: enriched.map(d => ({ name: d.name, value: d.value }))
          },

          // ç‡ˆè™Ÿå±¤ï¼šç”¨ warnScore åˆ¤æ–·ï¼Œå›ºå®šç¶ /é»ƒ/ç´…
          {
            name: 'é è­¦ç‡ˆè™Ÿ',
            type: 'scatter',
            coordinateSystem: 'geo',
            zlevel: 3,
            symbol: 'circle',
            symbolSize: 12,
            data: lightPoints,
            tooltip: { show: false },
            itemStyle: {
              color: (p) => lightColor(p.data.light),
              borderColor: 'rgba(15,23,42,.92)',
              borderWidth: 1.2,
              shadowBlur: 12,
              shadowColor: 'rgba(2,6,23,.25)',
              opacity: 0.95
            },
            emphasis: { scale: true }
          }
        ]
      };
      mapChart.setOption(mapOption, true);

      // =========================
      // 7-2) Top10 æ¢åœ–ï¼šä¾ç‡ˆè™Ÿè‘—è‰²
      // =========================
      const barOption = {
        backgroundColor: 'transparent',
        grid: { left: 110, right: 18, top: 18, bottom: 24 },
        xAxis: {
          type: 'value',
          axisLabel: { color: '#475569', fontWeight: 700 },
          splitLine: { show: true, lineStyle: { type: 'dashed', color: 'rgba(148,163,184,.45)' } }
        },
        yAxis: {
          type: 'category',
          data: top10.map(d => d.name),
          axisLabel: { color: '#334155', fontWeight: 800, fontSize: 12 }
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const p = params[0];
            const item = top10.find(d => d.name === p.name);
            if (!item) return '';
            const lt = lightText(item.light);
            const lc = lightColor(item.light);
            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
                  <div style="font-weight:900;color:#0b1220">${item.name}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;font-size:12px;line-height:1.45">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${item.value.toFixed(1)}</b> åˆ†</div>
                  <div>é è­¦åˆ†æ•¸ï¼š<b>${item.warnScore.toFixed(1)}</b> åˆ†</div>
                </div>
              </div>
            `;
          }
        },
        series: [
          {
            type: 'bar',
            barWidth: 16,
            data: top10.map(d => ({
              value: d.value,
              itemStyle: { color: lightColor(d.light), borderRadius: [0, 10, 10, 0] }
            })),
            label: {
              show: true,
              position: 'right',
              color: '#0b1220',
              fontWeight: 900,
              formatter: (p) => Number(p.value).toFixed(1)
            }
          }
        ]
      };
      barChart.setOption(barOption, true);
    }

    window.addEventListener('resize', () => {
      mapChart.resize();
      barChart.resize();
    });
  </script>
</body>
</html>
