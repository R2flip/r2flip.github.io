<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆæŒ‡æ¨™åˆ†æ•¸å³ç‡ˆè™Ÿï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ECharts + TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
/* =========================================================
   RESET & TOKENS
========================================================= */
*{ box-sizing:border-box; margin:0; padding:0; }

:root{
  --bg1:#0b1220;
  --bg2:#0f172a;

  --card: rgba(255,255,255,.94);
  --text:#0f172a;
  --muted:#64748b;

  --green:#22c55e;
  --yellow:#f59e0b;
  --red:#ef4444;

  --accent:#2563eb;

  --radius:18px;
  --radius-lg:20px;

  --shadow:0 14px 40px rgba(2,6,23,.18);
  --shadow-soft:0 10px 24px rgba(2,6,23,.14);
  --ring:0 0 0 3px rgba(37,99,235,.22);

  --stroke: rgba(148,163,184,.22);
}

/* =========================================================
   PAGE BASE
========================================================= */
body{
  font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  color:#e5e7eb;

  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.35), transparent 55%),
    radial-gradient(1000px 550px at 100% 0%, rgba(124,58,237,.18), transparent 55%),
    radial-gradient(900px 500px at 50% 110%, rgba(34,197,94,.14), transparent 55%),
    linear-gradient(180deg,#0b1020,#0b1220 40%,#0b1220);
}

/* =========================================================
   HEADER
========================================================= */
header{
  position:sticky;
  top:0;
  z-index:10;

  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:18px;

  padding:18px 22px;
  border-bottom:1px solid rgba(148,163,184,.16);
  backdrop-filter: blur(10px);

  background: linear-gradient(
    90deg,
    rgba(15,23,42,.72),
    rgba(37,99,235,.22),
    rgba(124,58,237,.16)
  );
}

header h1{
  font-size:1.22rem;
  font-weight:900;
  letter-spacing:.02em;
  line-height:1.25;
}

header .subtitle{
  margin-top:6px;
  font-size:.92rem;
  color:rgba(226,232,240,.92);
  line-height:1.35;
}

.meta-right{
  text-align:right;
  display:flex;
  flex-direction:column;
  gap:8px;
  font-size:.9rem;
  color:rgba(226,232,240,.88);
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:7px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(148,163,184,.18);
  box-shadow:0 10px 26px rgba(2,6,23,.18);
  white-space:nowrap;
}

/* =========================================================
   LAYOUT
========================================================= */
main.layout{
  flex:1;
  display:grid;
  grid-template-columns:minmax(640px,1fr) 360px;
  gap:16px;
  padding:16px 18px 18px;
  align-items:start;
}

/* =========================================================
   CARD SYSTEM
========================================================= */
.card{
  position:relative;
  background:var(--card);
  color:var(--text);
  border-radius:var(--radius-lg);
  border:1px solid var(--stroke);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute;
  inset:-1px;
  background:
    radial-gradient(600px 320px at 12% -10%, rgba(37,99,235,.10), transparent 60%),
    radial-gradient(520px 280px at 105% 0%, rgba(124,58,237,.08), transparent 60%);
  pointer-events:none;
}
.card-header{
  padding:12px 14px;
  border-bottom:1px solid rgba(148,163,184,.16);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
  z-index:1;
  background:linear-gradient(180deg, rgba(248,250,252,.96), rgba(241,245,249,.86));
}
.card-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:1rem;
  font-weight:950;
  letter-spacing:.01em;
}
.card-subtitle{
  font-size:.82rem;
  color:var(--muted);
  line-height:1.25;
  text-align:right;
  max-width:58%;
}
.card-body{
  padding:12px 14px 14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position:relative;
  z-index:1;
  min-height:0;
}

.card-icon{
  width: 32px; height: 32px;
  display:grid; place-items:center;
  border-radius: 12px;
  background: rgba(255,255,255,.85);
  border: 1px solid rgba(148,163,184,.25);
}

/* =========================================================
   MAP PANEL
========================================================= */
.map-panel{ display:flex; flex-direction:column; }
#mapContainer{
  flex:1;
  min-height:560px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.24);
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  box-shadow:
    inset 0 0 0 1px rgba(148,163,184,.18),
    inset 0 -30px 60px rgba(15,23,42,.06);
}
.legend-note{
  font-size:.82rem;
  color:#475569;
  line-height:1.5;
}

/* =========================================================
   RIGHT PANEL
========================================================= */
.control-panel{
  position:sticky;
  top:92px;
  height:calc(100dvh - 110px);
  overflow-y:auto;
  overflow-x:hidden;
  display:flex;
  flex-direction:column;
  gap:12px;
  padding-right:8px;
  overscroll-behavior:contain;
}
.control-panel::-webkit-scrollbar{ width:10px; }
.control-panel::-webkit-scrollbar-track{ background:transparent; }
.control-panel::-webkit-scrollbar-thumb{
  background:rgba(148,163,184,.40);
  border-radius:999px;
  border:2px solid rgba(255,255,255,.70);
}
.control-panel > .card{
  flex:0 0 auto;
  box-shadow:var(--shadow-soft);
}

/* =========================================================
   CONTROLS
========================================================= */
.controls{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.control-group{ display:flex; flex-direction:column; gap:6px; }
.control-label{
  font-size:.78rem;
  font-weight:900;
  color:#475569;
  letter-spacing:.01em;
}
select{
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.35);
  background:rgba(255,255,255,.96);
  font-size:.92rem;
  color:#0f172a;
  outline:none;
  transition: .15s ease;
}
select:hover{ border-color: rgba(148,163,184,.55); }
select:focus{
  border-color: rgba(37,99,235,.85);
  box-shadow: var(--ring);
  transform: translateY(-1px);
}

/* =========================================================
   PILLS / KPI
========================================================= */
.thresholds{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.pill,.kpi{
  padding:10px 12px;
  border-radius:14px;
  background:rgba(248,250,252,.96);
  border:1px solid rgba(148,163,184,.22);
}
.pill .p-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-size:.78rem;
  font-weight:950;
  color:#0f172a;
}
.pill .p-desc{
  margin-top:6px;
  font-size:.78rem;
  color:var(--muted);
  line-height:1.35;
}
.light-chip{
  font-size:.74rem;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.20);
  background:rgba(255,255,255,.92);
  font-weight:950;
  white-space:nowrap;
}
.chip-green{ color: #166534; border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
.chip-yellow{ color: #92400e; border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.12); }
.chip-red{ color: #991b1b; border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.12); }

.kpi-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.kpi3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
}
.kpi .k{
  font-size:.74rem;
  font-weight:900;
  color:#475569;
}
.kpi .v{
  margin-top:2px;
  font-size:1.25rem;
  font-weight:950;
  color:#0b1220;
  letter-spacing:.03em;
  font-variant-numeric: tabular-nums;
}
.kpi.badge-green .v{ color:#166534; }
.kpi.badge-yellow .v{ color:#92400e; }
.kpi.badge-red .v{ color:#991b1b; }

/* =========================================================
   BUTTONS
========================================================= */
.btn{
  padding:7px 12px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.30);
  background:rgba(255,255,255,.92);
  color:#0f172a;
  font-weight:950;
  cursor:pointer;
  transition:.15s ease;
  white-space:nowrap;
}
.btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(2,6,23,.12); }
.btn.red{
  background:rgba(239,68,68,.12);
  border-color:rgba(239,68,68,.24);
  color:#991b1b;
}
.btn.copy{
  background:rgba(37,99,235,.10);
  border-color:rgba(37,99,235,.24);
  color:#1d4ed8;
}
.footer-hint{
  margin-top:6px;
  font-size:.78rem;
  color:#64748b;
  line-height:1.35;
}

/* =========================
   Summary Card -> åˆ†ææ¢ä»¶é¢¨æ ¼ï¼ˆä¿®æ­£ç‰ˆï¼šæ›´è²¼è¿‘ä½ çš„ Card Systemï¼‰
========================= */
.summary-card{
  position: relative;

  /* è®“å®ƒè·Ÿ card system ä¸€è‡´ï¼ˆç”¨ tokenï¼‰ï¼ŒåŒæ™‚ä¿ç•™æ·±è‰²ç»ç’ƒæ„Ÿ */
  background:
    radial-gradient(900px 360px at 10% -10%, rgba(37,99,235,.14), transparent 55%),
    radial-gradient(820px 360px at 110% 0%, rgba(124,58,237,.12), transparent 55%),
    rgba(15, 23, 42, .58);

  color: #e5e7eb;

  border: 1px solid rgba(148,163,184,.22);
  border-radius: var(--radius-lg, 22px);

  box-shadow:
    0 22px 50px rgba(2, 6, 23, .42),
    inset 0 1px 0 rgba(255,255,255,.08);

  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  overflow: hidden;
}

/* äº®é‚Šå…‰æšˆï¼ˆåƒåˆ†ææ¢ä»¶å¡ï¼‰ */
.summary-card::before{
  content:"";
  position:absolute;
  inset:-1px;
  background:
    radial-gradient(600px 320px at 12% -10%, rgba(37,99,235,.18), transparent 60%),
    radial-gradient(520px 280px at 105% 0%, rgba(124,58,237,.14), transparent 60%);
  pointer-events:none;
  z-index:0;
}

/* è®“ header/body ä¸è¢« ::before è“‹ä½ */
.summary-card .card-header,
.summary-card .card-body{
  position: relative;
  z-index: 1;
}

/* æ¨™é¡Œå€ï¼šæ²¿ç”¨åˆ†ææ¢ä»¶çš„ã€Œæ·ºè‰² headerã€ä½†æ›´å’Œè«§ */
.summary-card .card-header{
  padding: 12px 14px;
  border-bottom: 1px solid rgba(148,163,184,.16);

  display:flex;
  justify-content:space-between;
  align-items:center;

  background: linear-gradient(
    180deg,
    rgba(248,250,252,.92),
    rgba(241,245,249,.82)
  );

  color: var(--text, #0f172a);
}

/* å…§å®¹å€ */
.summary-card .card-body{
  padding: 12px 14px 14px;
}



/* =========================================================
   TOP10 (åƒè€ƒåœ–ï¼šç™½åº•é¢æ¿ + è† å›Šæ¢)
========================================================= */
.top10-card .card-header{
  background: transparent;
  border-bottom: 0;
  padding: 14px 14px 6px;
}
.top10-card .card-title{ font-size: 1.05rem; font-weight: 950; }
.top10-card .card-subtitle{
  max-width: 64%;
  font-size: .9rem;
  font-weight: 800;
  color: #6b7280;
}
#barContainer{
  width:100%;
  height:240px;
  min-height:240px;
  background:#ffffff;
  border:1px solid rgba(148,163,184,.18);
  border-radius:16px;
}
.top10-card .legend-note{
  color:#94a3b8;
  font-weight:700;
  font-size:.85rem;
  margin-top: 8px;
}

/* =========================================================
   RED LIST
========================================================= */
#redList{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.red-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  border-radius:16px;
  background:linear-gradient(90deg, rgba(239,68,68,.14), rgba(239,68,68,.05));
  border:1px solid rgba(239,68,68,.22);
  font-weight:950;
  color:#7f1d1d;
  cursor:pointer;
  transition:.12s ease;
}
.red-item:hover{
  transform: translateY(-1px);
  box-shadow:0 12px 26px rgba(239,68,68,.12);
}
.red-item.active{
  outline: 3px solid rgba(239,68,68,.28);
  box-shadow:0 16px 34px rgba(239,68,68,.16);
}
.ok-item{
  padding:10px 12px;
  border-radius:14px;
  background:rgba(34,197,94,.10);
  border:1px solid rgba(34,197,94,.20);
  font-weight:950;
  color:#166534;
}

/* =========================================================
   MOBILE
========================================================= */
@media (max-width:1100px){
  main.layout{ grid-template-columns:1fr; }
  .control-panel{
    position:static;
    height:auto;
    overflow:visible;
    padding-right:0;
  }
  #mapContainer{ min-height:460px; }
  #barContainer{ height:260px; min-height:260px; }
}
@media (max-width:720px){
  header{ flex-direction:column; align-items:flex-start; }
  .meta-right{ align-items:flex-start; text-align:left; }
  main.layout{ padding:12px 12px 14px; }
  .controls{ grid-template-columns:1fr; }
  .thresholds{ grid-template-columns:1fr; }
  .kpi-row{ grid-template-columns:1fr; }
  .kpi3{ grid-template-columns:1fr 1fr; }
}

 /* =========================================================
   RIGHT PANEL â€“ çµ±ä¸€è¦–è¦ºï¼ˆæ”¾åœ¨ CSS æœ€å¾Œï¼‰
========================================================= */

/* å³æ¬„å¡ç‰‡é–“è·æ›´èˆ’æœ + æ»¾å‹•æ›´ä¹¾æ·¨ */
.control-panel{
  gap:14px;
}

/* Header å³å´ actions çµ±ä¸€ */
.card-actions{
  display:flex;
  align-items:center;
  gap:8px;
}

/* å³æ¬„æ‰€æœ‰ card header å­—é«”/é–“è·æ›´ä¸€è‡´ */
.control-panel .card-header{
  padding:12px 14px;
}

/* å³æ¬„æ‰€æœ‰ card body ä¸€è‡´ */
.control-panel .card-body{
  padding:12px 14px 14px;
  gap:12px;
}

/* icon è¦–è¦ºæ›´ä¸€è‡´ï¼ˆé¿å…æ¯å¼µå¡ icon äº®åº¦ä¸åŒï¼‰ */
.control-panel .card-icon{
  background: rgba(255,255,255,.88);
  border: 1px solid rgba(148,163,184,.26);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.85);
}

/* =========================================================
   Summary Cardï¼ˆæ·±è‰²ç»ç’ƒï¼‰â€” å³æ¬„é¢¨æ ¼ä¸€è‡´åŒ–
========================================================= */

/* è®“ summary-card è·Ÿ card system çµæ§‹ä¸€è‡´ï¼Œä½†ç¶­æŒæ·±è‰²ç»ç’ƒ */
.summary-card{
  border-radius: var(--radius-lg);
}

/* æ·±è‰²å¡çš„ header æ”¹ç‚ºã€ŒåŠé€æ˜äº® headerã€ï¼šè·Ÿå…¶å®ƒå¡ä¸€è‡´ï¼Œä½†ä¸çªå…€ */
.summary-card .card-header{
  background: linear-gradient(
    180deg,
    rgba(248,250,252,.92),
    rgba(241,245,249,.78)
  );
  border-bottom: 1px solid rgba(148,163,184,.16);
  color: var(--text);
}

/* æ·±è‰²å¡ body å…§éƒ¨çµ±ä¸€ã€Œç™½è‰²è† å›Šã€æ¨¡çµ„ï¼Œè¦–è¦ºä¸€è‡´ */
.summary-card .sel-pill{
  background: rgba(248,250,252,.94);
  border: 1px solid rgba(148,163,184,.22);
  border-radius: 16px;
  padding: 12px 14px;
  box-shadow:
    0 10px 24px rgba(2,6,23,.14),
    inset 0 1px 0 rgba(255,255,255,.85);
}

.summary-card .sel-pill + .sel-pill{ margin-top: 10px; }

.summary-card .sel-line{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

/* key/value æ’ç‰ˆï¼ˆè·Ÿ KPI/pill ç³»çµ±åŒèªå½™ï¼‰ */
.summary-card .k{
  font-size:.78rem;
  font-weight:900;
  color:#475569;
  letter-spacing:.01em;
}
.summary-card .v{
  margin-top:4px;
  font-size:1.04rem;
  font-weight:950;
  color:#0b1220;
  letter-spacing:.01em;
  font-variant-numeric: tabular-nums;
}

/* badgeï¼šæ”¹æˆã€Œå¯è¢« JS color æ§åˆ¶ã€çš„è† å›Šï¼Œé¿å…åªæœ‰æ–‡å­—è®Šè‰²çœ‹èµ·ä¾†æ€ª */
.summary-card .sel-badge{
  min-width: 56px;
  height: 30px;
  padding: 0 12px;
  border-radius: 999px;
  display:inline-flex;
  align-items:center;
  justify-content:center;

  background: rgba(255,255,255,.92);
  border: 1px solid rgba(148,163,184,.26);
  box-shadow: 0 10px 20px rgba(2,6,23,.12);

  font-weight: 950;
  color: #0f172a; /* é è¨­ï¼ŒJS æœƒè¦†è“‹ */
}

/* å¥å­å€ï¼šåšæˆã€Œå¯ç›´æ¥è²¼å ±å‘Šã€çš„å°é¢æ¿ */
.summary-card #selSentence{
  font-size:.92rem !important;
  line-height:1.45 !important;
  font-weight:900 !important;
  color:#0f172a !important;

  background: rgba(255,255,255,.92);
  border: 1px solid rgba(148,163,184,.20);
  border-radius: 14px;
  padding: 10px 12px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.86);
}

/* å…©æ¬„è³‡è¨Šåœ¨å³æ¬„æ›´ä¸æ“  */
.summary-card .sel-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media (max-width:560px){
  .summary-card .sel-grid{ grid-template-columns:1fr; }
}

/* =========================================================
   Top10 å¡ï¼šç§»é™¤ã€Œé€æ˜ headerã€çš„ç‰¹æ®ŠåŒ–ï¼Œæ”¹ç‚ºèˆ‡å…¶å®ƒå¡ä¸€è‡´
   ï¼ˆè«‹æŠŠä½ åŸæœ¬ TOP10 é‚£æ®µ .top10-card .card-header{background:transparent...} åˆªæ‰/è¨»è§£ï¼‰
========================================================= */

.top10-card .card-header{
  background: linear-gradient(180deg, rgba(248,250,252,.96), rgba(241,245,249,.86));
  border-bottom:1px solid rgba(148,163,184,.16);
  padding:12px 14px;
}

/* barContainer è¦–è¦ºæ›´åƒå¡å…§é¢æ¿ */
#barContainer{
  width:100%;
  height:240px;
  min-height:240px;

  background: linear-gradient(180deg, #ffffff, #f8fafc);
  border: 1px solid rgba(148,163,184,.20);
  border-radius: 16px;

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.85),
    inset 0 -28px 60px rgba(15,23,42,.05);
}

/* Top10 æ–‡å­—èªªæ˜ä¸€è‡´åŒ– */
.top10-card .legend-note{
  color:#64748b;
  font-weight:750;
  font-size:.82rem;
  margin-top: 2px;
  line-height:1.4;
}

/* =========================================================
   ç´…ç‡ˆæ¸…å–®ï¼šåˆ—è¡¨é …ç›®é«˜åº¦/åœ“è§’/é™°å½±ä¸€è‡´åŒ–
========================================================= */
.red-item{
  border-radius: 16px;
  padding: 10px 12px;
  border:1px solid rgba(239,68,68,.22);
  box-shadow: 0 10px 22px rgba(239,68,68,.10);
}
.red-item:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 26px rgba(239,68,68,.14);
}
.red-item.active{
  outline: 3px solid rgba(239,68,68,.24);
  box-shadow: 0 18px 34px rgba(239,68,68,.16);
}

/* ç„¡ç´…ç‡ˆ/ç„¡è³‡æ–™ç‹€æ…‹ä¹Ÿç”¨åŒä¸€å¥—ã€Œpillã€èªå½™ */
.ok-item{
  padding:10px 12px;
  border-radius: 16px;
  background: rgba(248,250,252,.96);
  border: 1px solid rgba(148,163,184,.22);
  font-weight: 900;
  color: #475569;
}

/* =========================================================
   å°ä¿®ï¼šå³æ¬„æŒ‰éˆ•ä¸€è‡´åŒ–ï¼ˆæ›´åƒå·¥å…·åˆ—ï¼‰
========================================================= */
.control-panel .btn{
  box-shadow: inset 0 1px 0 rgba(255,255,255,.80);
}
.control-panel .btn:hover{
  transform: translateY(-1px);
  box-shadow:
    0 10px 24px rgba(2,6,23,.12),
    inset 0 1px 0 rgba(255,255,255,.85);
}
   
  </style>
</head>

<body>
  <header>
    <div class="hgroup">
      <h1>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆæŒ‡æ¨™åˆ†æ•¸å³ç‡ˆè™Ÿï¼‰</h1>
      <div class="subtitle">è³‡è¨Šåˆ†å±¤ï¼šä¸»è¦–è¦ºåœ°åœ– â†’ å³æ¬„æ±ºç­–æ‘˜è¦ï¼ˆæ¢ä»¶/æ‘˜è¦/Top10/ç´…ç‡ˆæ¸…å–®ï¼‰</div>
    </div>
    <div class="meta-right">
      <div class="badge">è³‡æ–™ä¾†æºï¼šTCCAS æ ¡åœ’èª¿æŸ¥ã€ç·šä¸Šå•å·ï¼ˆç¤ºç¯„è³‡æ–™ï¼‰</div>
      <div class="subtitle" id="currentMeta">å¹´åº¦ï¼šâ€”ã€€ï½œã€€æŒ‡æ¨™ï¼šâ€”</div>
    </div>
  </header>

  <main class="layout">
    <!-- å·¦å´ï¼šåœ°åœ– -->
    <section class="card map-panel">
      <div class="card-header">
        <div class="card-title">
          å„ç¸£å¸‚ç†±åŠ›åœ– & ç‡ˆè™Ÿ
        </div>
        <div class="card-subtitle" id="mapSubtitle">
          ç†±åŠ›åœ–ï¼šæŒ‡æ¨™åˆ†æ•¸ï¼ˆvalueï¼‰<br/>
          åœ“é»ï¼šç‡ˆè™Ÿï¼ˆç”±æŒ‡æ¨™åˆ†æ•¸åˆ¤å®šï¼‰
        </div>
      </div>

      <div class="card-body">
        <div id="mapContainer"></div>
        <div class="legend-note">
          èªªæ˜ï¼šç†±åŠ›åœ–é¡è‰²è¡¨ç¤º<strong>æŒ‡æ¨™åˆ†æ•¸</strong>ï¼›åœ“é»ç‡ˆè™Ÿäº¦ç”±<strong>åŒä¸€æŒ‡æ¨™åˆ†æ•¸</strong>ä¾é–€æª»åˆ¤å®šã€‚é»æ“Šç¸£å¸‚å¯åœ¨å³æ¬„è‡ªå‹•ç”Ÿæˆæ‘˜è¦ä¸¦å®šä½ç´…ç‡ˆæ¸…å–®ã€‚
        </div>
      </div>
    </section>

    <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
    <aside class="control-panel">

      <!-- 1) åˆ†ææ¢ä»¶ -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-icon">âš™</span>
            åˆ†ææ¢ä»¶
          </div>
          <div class="card-subtitle">å¹´åº¦ / æŒ‡æ¨™ / é–€æª»</div>
        </div>

        <div class="card-body">
          <div class="controls">
            <div class="control-group">
              <label for="yearSelect" class="control-label">å¹´åº¦</label>
              <select id="yearSelect">
                <option value="2024" selected>2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
              </select>
            </div>

            <div class="control-group">
              <label for="metricSelect" class="control-label">æŒ‡æ¨™é¡å‹</label>
              <select id="metricSelect">
                <option value="mean_score" selected>å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
                <option value="high_risk_pct">ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
                <option value="severe_score">å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
              </select>
            </div>
          </div>

          <div class="thresholds">
            <div class="pill">
              <div class="p-title">
                ç¶ ç‡ˆé–€æª» <span class="light-chip chip-green">ç¶ </span>
              </div>
              <div class="p-desc" id="thGreen">â€”</div>
            </div>

            <div class="pill">
              <div class="p-title">
                é»ƒç‡ˆé–€æª» <span class="light-chip chip-yellow">é»ƒ</span>
              </div>
              <div class="p-desc" id="thYellow">â€”</div>
            </div>
          </div>

          <div class="pill">
            <div class="p-title">
              ç´…ç‡ˆæ¢ä»¶ <span class="light-chip chip-red">ç´…</span>
            </div>
            <div class="p-desc" id="thRed">â€”</div>
            <div class="footer-hint">â€» å¿ƒç†éŸŒæ€§ç‚ºåå‘ç‡ˆè™Ÿï¼ˆé«˜åˆ†â†’ç¶ ï¼‰</div>
          </div>

          <div class="kpi-row">
            <div class="kpi">
              <div class="k">å…¨åœ‹å¹³å‡ï¼ˆæŒ‡æ¨™ï¼‰</div>
              <div class="v" id="statAvg">â€”</div>
            </div>
            <div class="kpi">
              <div class="k">æœ€é«˜ç¸£å¸‚ï¼ˆæŒ‡æ¨™ï¼‰</div>
              <div class="v" id="statMax">â€”</div>
            </div>
          </div>

          <div class="kpi3">
            <div class="kpi badge-green">
              <div class="k">ç¶ ç‡ˆæ•¸</div>
              <div class="v" id="statGreen">â€”</div>
            </div>
            <div class="kpi badge-yellow">
              <div class="k">é»ƒç‡ˆæ•¸</div>
              <div class="v" id="statYellow">â€”</div>
            </div>
            <div class="kpi badge-red">
              <div class="k">ç´…ç‡ˆæ•¸</div>
              <div class="v" id="statRed">â€”</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 2) é¸å–æ‘˜è¦ -->
      <section class="card summary-card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-icon">ğŸ“Œ</span>
            é¸å–ç¸£å¸‚æ‘˜è¦
          </div>
          <div class="card-actions">
            <button id="copySummary" class="btn copy">è¤‡è£½æ‘˜è¦</button>
          </div>
        </div>

        <div class="card-body">
          <div class="sel-pill">
            <div class="sel-line">
              <div class="k">ç¸£å¸‚</div>
              <div class="sel-badge" id="selLight">â€”</div>
            </div>
            <div class="v" id="selName">å°šæœªé¸å–ï¼ˆé»åœ°åœ–æˆ–é»ç´…ç‡ˆæ¸…å–®ï¼‰</div>
          </div>

          <div class="sel-grid">
            <div class="sel-pill">
              <div class="k">æŒ‡æ¨™åˆ†æ•¸ï¼ˆvalueï¼‰</div>
              <div class="v" id="selValue">â€”</div>
            </div>
            <div class="sel-pill">
              <div class="k">ç‡ˆè™Ÿåˆ¤å®š</div>
              <div class="v" id="selRule">ä¾æŒ‡æ¨™åˆ†æ•¸é–€æª»</div>
            </div>
          </div>

          <div class="sel-pill">
            <div class="k">æ”¿ç­–æ‘˜è¦å¥ï¼ˆå¯ç›´æ¥è²¼å ±å‘Šï¼‰</div>
            <div class="v" id="selSentence">â€”</div>
          </div>
        </div>
      </section>

      <!-- 3) Top10 -->
      <section class="card top10-card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-icon">ğŸ“Š</span>
            Top 10 ç¸£å¸‚æ¯”è¼ƒ
          </div>
          <div class="card-subtitle" id="barTitle">â€”</div>
        </div>

        <div class="card-body">
          <div id="barContainer"></div>
          <div class="legend-note">
            ï¼ŠTop10 ä¾ã€ŒæŒ‡æ¨™åˆ†æ•¸ã€æ’åºï¼›X è»¸ç¯„åœä¾è³‡æ–™è‡ªå‹•èª¿æ•´ã€‚
          </div>
        </div>
      </section>

      <!-- 4) ç´…ç‡ˆæ¸…å–® + CSV -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="card-icon" style="background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.20);color:#b91c1c;">ğŸ”´</span>
            ç´…ç‡ˆç¸£å¸‚æ¸…å–®
          </div>
          <div class="card-actions">
            <button id="downloadCSV" class="btn red">ä¸‹è¼‰ CSV</button>
          </div>
        </div>

        <div class="card-body">
          <ul id="redList"></ul>
          <div class="legend-note">â€» ä¾ã€ŒæŒ‡æ¨™åˆ†æ•¸ã€èˆ‡é–€æª»åˆ¤å®šï¼ˆå¿ƒç†éŸŒæ€§ç‚ºåå‘ç‡ˆè™Ÿï¼‰</div>
        </div>
      </section>

    </aside>
  </main>

  <script>
    // =========================
    // 0) æª”æ¡ˆè¨­å®š
    // =========================
    const TOPO_URL = 'twCounty_22counties_topo.json';

    // =========================
    // 1) æ¨¡æ“¬è³‡æ–™ï¼ˆç¤ºç¯„ï¼‰
    //    â€» å³ä½¿æœ‰ warn æ¬„ä½ä¹Ÿæœƒè¢«å¿½ç•¥ï¼›ç‡ˆè™Ÿå®Œå…¨ç”± value åˆ¤å®š
    // =========================
    const climateAnxietyData = {
      "2024": {
        "mean_score": [
          { name: "å°åŒ—å¸‚", value: 78, warn: 80 },
          { name: "æ–°åŒ—å¸‚", value: 72, warn: 73 },
          { name: "æ¡ƒåœ’å¸‚", value: 70, warn: 69 },
          { name: "å°ä¸­å¸‚", value: 69, warn: 68 },
          { name: "å°å—å¸‚", value: 65, warn: 64 },
          { name: "é«˜é›„å¸‚", value: 75, warn: 77 },
          { name: "åŸºéš†å¸‚", value: 68, warn: 70 },
          { name: "æ–°ç«¹å¸‚", value: 80, warn: 83 },
          { name: "å˜‰ç¾©å¸‚", value: 66, warn: 65 },
          { name: "æ–°ç«¹ç¸£", value: 77, warn: 79 },
          { name: "è‹—æ —ç¸£", value: 62, warn: 60 },
          { name: "å½°åŒ–ç¸£", value: 60, warn: 59 },
          { name: "å—æŠ•ç¸£", value: 63, warn: 61 },
          { name: "é›²æ—ç¸£", value: 58, warn: 57 },
          { name: "å˜‰ç¾©ç¸£", value: 59, warn: 58 },
          { name: "å±æ±ç¸£", value: 67, warn: 66 },
          { name: "å®œè˜­ç¸£", value: 71, warn: 72 },
          { name: "èŠ±è“®ç¸£", value: 69, warn: 70 },
          { name: "å°æ±ç¸£", value: 68, warn: 69 },
          { name: "æ¾æ¹–ç¸£", value: 61, warn: 60 },
          { name: "é‡‘é–€ç¸£", value: 55, warn: 54 },
          { name: "é€£æ±Ÿç¸£", value: 52, warn: 51 }
        ],
        "high_risk_pct": [
          { name: "å°åŒ—å¸‚", value: 26, warn: 27 },
          { name: "æ–°åŒ—å¸‚", value: 22, warn: 23 },
          { name: "é«˜é›„å¸‚", value: 24, warn: 25 },
          { name: "æ–°ç«¹å¸‚", value: 28, warn: 29 },
          { name: "æ–°ç«¹ç¸£", value: 25, warn: 26 },
          { name: "å°ä¸­å¸‚", value: 21, warn: 21 },
          { name: "å±æ±ç¸£", value: 20, warn: 20 },
          { name: "å®œè˜­ç¸£", value: 23, warn: 24 },
          { name: "èŠ±è“®ç¸£", value: 22, warn: 22 },
          { name: "å°æ±ç¸£", value: 21, warn: 21 },
          { name: "å°å—å¸‚", value: 19, warn: 19 },
          { name: "å˜‰ç¾©å¸‚", value: 18, warn: 18 }
        ],
        "severe_score": [
          { name: "å°åŒ—å¸‚", value: 84, warn: 82 },
          { name: "æ–°åŒ—å¸‚", value: 81, warn: 79 },
          { name: "æ¡ƒåœ’å¸‚", value: 79, warn: 77 },
          { name: "å°ä¸­å¸‚", value: 78, warn: 76 },
          { name: "é«˜é›„å¸‚", value: 85, warn: 83 },
          { name: "æ–°ç«¹å¸‚", value: 86, warn: 84 },
          { name: "æ–°ç«¹ç¸£", value: 83, warn: 81 },
          { name: "å±æ±ç¸£", value: 80, warn: 78 },
          { name: "å®œè˜­ç¸£", value: 82, warn: 80 },
          { name: "èŠ±è“®ç¸£", value: 81, warn: 79 },
          { name: "å°æ±ç¸£", value: 80, warn: 78 }
        ]
      },
      "2023": { "mean_score": [], "high_risk_pct": [], "severe_score": [] },
      "2022": { "mean_score": [], "high_risk_pct": [], "severe_score": [] }
    };

    // =========================
    // 2) ç‡ˆè™Ÿé–€æª»ï¼ˆä»¥ã€ŒæŒ‡æ¨™åˆ†æ•¸ valueã€åˆ¤å®šï¼›å¿ƒç†éŸŒæ€§åå‘ï¼‰
    // =========================
    const warnThresholds = {
      mean_score:    { greenMax: 65, yellowMax: 75 },
      high_risk_pct: { greenMax: 20, yellowMax: 25 },
      severe_score:  { greenMax: 72, yellowMax: 82 }
    };

    function getLight(metric, value){
      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };

      // å¿ƒç†éŸŒæ€§ï¼šé«˜åˆ†å¥½ï¼ˆåå‘ï¼‰
      if (metric === "severe_score") {
        if (value >= t.yellowMax) return "green";
        if (value >= t.greenMax) return "yellow";
        return "red";
      }

      // å…¶ä»–æŒ‡æ¨™ï¼šé«˜åˆ†é¢¨éšªé«˜
      if (value <= t.greenMax) return "green";
      if (value <= t.yellowMax) return "yellow";
      return "red";
    }

    function lightText(light){
      return light === "green" ? "ç¶ ç‡ˆ" : light === "yellow" ? "é»ƒç‡ˆ" : "ç´…ç‡ˆ";
    }
    function lightColor(light){
      return light === "green" ? "#22c55e" : light === "yellow" ? "#f59e0b" : "#ef4444";
    }
    function metricLabel(metric){
      return ({
        mean_score: "å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        high_risk_pct: "ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        severe_score: "å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰"
      })[metric] || metric;
    }

    // =========================
    // 3) DOM + åœ–è¡¨åˆå§‹åŒ–
    // =========================
    const mapChart = echarts.init(document.getElementById('mapContainer'));
    const barChart = echarts.init(document.getElementById('barContainer'));

    const yearSelect = document.getElementById('yearSelect');
    const metricSelect = document.getElementById('metricSelect');

    const currentMeta = document.getElementById('currentMeta');
    const barTitle = document.getElementById('barTitle');

    const statAvg = document.getElementById('statAvg');
    const statMax = document.getElementById('statMax');
    const statGreen = document.getElementById('statGreen');
    const statYellow = document.getElementById('statYellow');
    const statRed = document.getElementById('statRed');

    const thGreen = document.getElementById('thGreen');
    const thYellow = document.getElementById('thYellow');
    const thRed = document.getElementById('thRed');

    const redList = document.getElementById('redList');
    const downloadCSV = document.getElementById('downloadCSV');

    const selName = document.getElementById('selName');
    const selLight = document.getElementById('selLight');
    const selValue = document.getElementById('selValue');
    const selSentence = document.getElementById('selSentence');
    const copySummary = document.getElementById('copySummary');

    let countyCentroid = new Map();
    let MAIN_ISLAND_BBOX = null;

    let selectedCounty = null;
    let lastEnriched = [];

    // =========================
    // 4) å¹¾ä½•ï¼šcentroid + æœ¬å³¶ bbox
    // =========================
    function centroidOfPolygon(coords){
      const ring = coords?.[0];
      if (!ring || ring.length < 3) return null;
      let area = 0, cx = 0, cy = 0;
      for (let i = 0; i < ring.length - 1; i++){
        const [x1,y1] = ring[i];
        const [x2,y2] = ring[i+1];
        const a = x1*y2 - x2*y1;
        area += a;
        cx += (x1 + x2) * a;
        cy += (y1 + y2) * a;
      }
      area *= 0.5;
      if (Math.abs(area) < 1e-10) return ring[0];
      cx /= (6*area);
      cy /= (6*area);
      return [cx, cy];
    }

    function centroidOfGeometry(geom){
      if (!geom) return null;
      if (geom.type === "Polygon") return centroidOfPolygon(geom.coordinates);
      if (geom.type === "MultiPolygon"){
        let best = null, bestArea = -Infinity;
        for (const poly of geom.coordinates){
          const ring = poly?.[0];
          if (!ring || ring.length < 3) continue;
          let area = 0;
          for (let i=0;i<ring.length-1;i++){
            const [x1,y1]=ring[i], [x2,y2]=ring[i+1];
            area += (x1*y2 - x2*y1);
          }
          const absA = Math.abs(area * 0.5);
          if (absA > bestArea){
            bestArea = absA;
            best = centroidOfPolygon(poly);
          }
        }
        return best;
      }
      return null;
    }

    function buildCentroids(geoJson){
      countyCentroid.clear();
      for (const f of geoJson.features || []){
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        const c = centroidOfGeometry(f.geometry);
        if (name && c) countyCentroid.set(name, c);
      }
    }
    function getCountyCoord(name){ return countyCentroid.get(name) || null; }

    const EXCLUDE_COUNTIES = new Set(["æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"]);

    function expandBbox(b, x, y) {
      if (!b) return { minX: x, minY: y, maxX: x, maxY: y };
      return {
        minX: Math.min(b.minX, x),
        minY: Math.min(b.minY, y),
        maxX: Math.max(b.maxX, x),
        maxY: Math.max(b.maxY, y)
      };
    }
    function bboxOfCoords(coords, bbox) {
      if (!coords) return bbox;
      if (typeof coords[0] === "number") return expandBbox(bbox, coords[0], coords[1]);
      for (const c of coords) bbox = bboxOfCoords(c, bbox);
      return bbox;
    }
    function computeMainIslandBoundingCoords(geoJson) {
      let bbox = null;
      for (const f of (geoJson.features || [])) {
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        if (EXCLUDE_COUNTIES.has(name)) continue;
        bbox = bboxOfCoords(f.geometry?.coordinates, bbox);
      }
      if (!bbox) return null;
      return [[bbox.minX, bbox.minY], [bbox.maxX, bbox.maxY]];
    }

    // =========================
    // 5) é¸å–äº’å‹•ï¼šé«˜äº® + æ‘˜è¦æ›´æ–°
    // =========================
    function highlightOnMap(name){
      try{
        if (selectedCounty) {
          mapChart.dispatchAction({ type: 'downplay', seriesIndex: 0, name: selectedCounty });
        }
        mapChart.dispatchAction({ type: 'highlight', seriesIndex: 0, name });
        mapChart.dispatchAction({ type: 'showTip', seriesIndex: 0, name });
      }catch(e){}
    }

    function highlightRedList(name){
      const el = redList.querySelector(`li[data-county="${name}"]`);
      redList.querySelectorAll('.red-item.active').forEach(x => x.classList.remove('active'));
      if (el){
        el.classList.add('active');
        el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function makePolicySentence({year, metricText, county, value, light}){
      const lt = lightText(light);

      if (metricSelect.value === "severe_score"){
        if (light === "red"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œé¡¯ç¤ºå¿ƒç†éŸŒæ€§åä½ï¼Œå»ºè­°å„ªå…ˆé…ç½®å¿ƒç†æ”¯æŒèˆ‡éŸŒæ€§å¼·åŒ–è³‡æºã€‚`;
        }
        if (light === "yellow"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œå¿ƒç†éŸŒæ€§ä¸­ç­‰ï¼Œå»ºè­°æŒçºŒç›£æ¸¬ä¸¦åŠ å¼·ç¤¾å€/æ ¡åœ’éŸŒæ€§ä»‹å…¥ã€‚`;
        }
        return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œå¿ƒç†éŸŒæ€§è¡¨ç¾è‰¯å¥½ï¼Œå¯ä½œç‚ºæ¨å»£éŸŒæ€§ç­–ç•¥ä¹‹åƒè€ƒã€‚`;
      } else {
        if (light === "red"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œé¢¨éšªåé«˜ï¼Œå»ºè­°åˆ—å…¥å„ªå…ˆé—œæ³¨èˆ‡æ”¿ç­–ä»‹å…¥ç¸£å¸‚ã€‚`;
        }
        if (light === "yellow"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œå‘ˆç¾è­¦æˆ’å¾µå…†ï¼Œå»ºè­°åŠ å¼·å®£å°èˆ‡é é˜²æ€§æ”¯æŒã€‚`;
        }
        return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)} åˆ†ï¼ˆ${lt}ï¼‰ï¼Œæ•´é«”é¢¨éšªè¼ƒä½ï¼Œå»ºè­°ç¶­æŒæ—¢æœ‰æ”¯æŒæ©Ÿåˆ¶ä¸¦æŒçºŒè¿½è¹¤ã€‚`;
      }
    }

    function updateSelectedSummary(item){
      if (!item){
        selName.textContent = "å°šæœªé¸å–ï¼ˆé»åœ°åœ–æˆ–é»ç´…ç‡ˆæ¸…å–®ï¼‰";
        selLight.textContent = "â€”";
        selLight.style.color = "#0f172a";
        selValue.textContent = "â€”";
        selSentence.textContent = "â€”";
        return;
      }

      const year = yearSelect.value;
      const metricText = metricLabel(metricSelect.value);

      selName.textContent = item.name;
      selValue.textContent = `${Number(item.value).toFixed(1)} åˆ†`;

      selLight.textContent = lightText(item.light);
      selLight.style.color = lightColor(item.light);

      selSentence.textContent = makePolicySentence({
        year,
        metricText,
        county: item.name,
        value: Number(item.value),
        light: item.light
      });
    }

    function selectCounty(name){
      selectedCounty = name;
      highlightOnMap(name);
      highlightRedList(name);
      const item = lastEnriched.find(x => x.name === name) || null;
      updateSelectedSummary(item);
    }

    copySummary.addEventListener('click', async () => {
      const text = selSentence.textContent?.trim();
      if (!text || text === "â€”") return;
      try{
        await navigator.clipboard.writeText(text);
        copySummary.textContent = "å·²è¤‡è£½";
        setTimeout(()=> copySummary.textContent = "è¤‡è£½æ‘˜è¦", 900);
      }catch(e){
        alert("ç€è¦½å™¨æœªå…è¨±å‰ªè²¼ç°¿å­˜å–ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ‘˜è¦æ–‡å­—ã€‚");
      }
    });

    // =========================
    // 6) CSV ä¸‹è¼‰ï¼ˆç´…ç‡ˆç¸£å¸‚ï¼‰
    // =========================
    downloadCSV.addEventListener('click', () => {
      const year = yearSelect.value;
      const metric = metricSelect.value;
      const metricText = metricLabel(metric);

      const rows = [["å¹´åº¦","ç¸£å¸‚","æŒ‡æ¨™é¡å‹","æŒ‡æ¨™åˆ†æ•¸","ç‡ˆè™Ÿ"]];
      const raw = climateAnxietyData[year]?.[metric] || [];

      raw.forEach(d => {
        const light = getLight(metric, d.value);
        if (light === "red") rows.push([year, d.name, metricText, d.value, "ç´…ç‡ˆ"]);
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${year}_${metric}_ç´…ç‡ˆç¸£å¸‚æ¸…å–®.csv`;
      a.click();

      URL.revokeObjectURL(url);
    });

    // =========================
    // 7) è¼‰å…¥åœ°åœ– + é¦–æ¬¡ç¹ªè£½
    // =========================
    fetch(TOPO_URL)
      .then(res => res.json())
      .then(topoData => {
        const objKey = topoData.objects && (topoData.objects.layer1 ? "layer1" : Object.keys(topoData.objects)[0]);
        const geo = topojson.feature(topoData, topoData.objects[objKey]);

        buildCentroids(geo);
        MAIN_ISLAND_BBOX = computeMainIslandBoundingCoords(geo);

        echarts.registerMap('taiwan', geo);
        updateCharts();
      })
      .catch(err => {
        console.error('è¼‰å…¥ TopoJSON å¤±æ•—ï¼š', err);
        alert('è«‹ç¢ºèª twCounty_22counties_topo.json è·¯å¾‘æ­£ç¢ºï¼Œä¸”ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿã€‚');
      });

    yearSelect.addEventListener('change', updateCharts);
    metricSelect.addEventListener('change', updateCharts);

    mapChart.on('click', (params) => {
      if (!params || !params.name) return;
      selectCounty(params.name);
    });

    // =========================
    // 8) Top10 X è»¸è‡ªå‹• maxï¼ˆæ¼‚äº®çš„åˆ»åº¦ï¼‰
    // =========================
    function niceMax(maxVal){
      if (!isFinite(maxVal) || maxVal <= 0) return 1;
      const padded = maxVal * 1.08;
      const mag = Math.pow(10, Math.floor(Math.log10(padded)));
      const norm = padded / mag;
      let nice;
      if (norm <= 1) nice = 1;
      else if (norm <= 1.5) nice = 1.5;
      else if (norm <= 2) nice = 2;
      else if (norm <= 3) nice = 3;
      else if (norm <= 5) nice = 5;
      else nice = 10;
      return nice * mag;
    }

    // =========================
    // 9) æ›´æ–°ä¸»å‡½å¼
    // =========================
    function updateCharts(){
      const year = yearSelect.value;
      const metric = metricSelect.value;

      const metricText = metricLabel(metric);
      currentMeta.textContent = `å¹´åº¦ï¼š${year}ã€€ï½œã€€æŒ‡æ¨™ï¼š${metricText}`;
      barTitle.textContent = `${year} å¹´ ${metricText}ï¼ˆå‰ 10 åï¼‰`;

      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };

      // é–€æª»æ–‡æ¡ˆï¼šæ”¹æˆã€ŒæŒ‡æ¨™åˆ†æ•¸ã€
      if (metric === "severe_score") {
        thGreen.textContent  = `æŒ‡æ¨™åˆ†æ•¸ â‰¥ ${t.yellowMax} â†’ ç¶ ç‡ˆï¼ˆéŸŒæ€§é«˜ï¼‰`;
        thYellow.textContent = `æŒ‡æ¨™åˆ†æ•¸ ${t.greenMax} ï½ ${t.yellowMax - 0.1} â†’ é»ƒç‡ˆï¼ˆä¸­ç­‰ï¼‰`;
        thRed.textContent    = `æŒ‡æ¨™åˆ†æ•¸ < ${t.greenMax} â†’ ç´…ç‡ˆï¼ˆéŸŒæ€§ä¸è¶³ï¼‰`;
      } else {
        thGreen.textContent  = `æŒ‡æ¨™åˆ†æ•¸ â‰¤ ${t.greenMax} â†’ ç¶ ç‡ˆï¼ˆä½é¢¨éšªï¼‰`;
        thYellow.textContent = `æŒ‡æ¨™åˆ†æ•¸ ${t.greenMax + 0.1} ï½ ${t.yellowMax} â†’ é»ƒç‡ˆï¼ˆæ³¨æ„ï¼‰`;
        thRed.textContent    = `æŒ‡æ¨™åˆ†æ•¸ > ${t.yellowMax} â†’ ç´…ç‡ˆï¼ˆé«˜é¢¨éšªï¼‰`;
      }

      const raw = climateAnxietyData[year]?.[metric] || [];
      if (!raw.length){
        mapChart.clear();
        barChart.clear();
        statAvg.textContent = 'ç„¡è³‡æ–™';
        statMax.textContent = 'ç„¡è³‡æ–™';
        statGreen.textContent = 'â€”';
        statYellow.textContent = 'â€”';
        statRed.textContent = 'â€”';
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡è³‡æ–™</li>`;
        lastEnriched = [];
        selectedCounty = null;
        updateSelectedSummary(null);
        return;
      }

      // âœ… åˆä½µï¼šç‡ˆè™Ÿç”± value åˆ¤å®š
      const enriched = raw.map(d => {
        const light = getLight(metric, d.value);
        return { ...d, light };
      });
      lastEnriched = enriched;

      const values = enriched.map(d => d.value);
      const avg = values.reduce((a,b)=>a+b,0) / values.length;
      const maxVal = Math.max(...values);
      const maxItem = enriched.find(d => d.value === maxVal);

      statAvg.textContent = `${avg.toFixed(1)} åˆ†`;
      statMax.textContent = `${maxItem.name}ï¼š${maxItem.value.toFixed(1)} åˆ†`;

      const greenCount = enriched.filter(d => d.light === "green").length;
      const yellowCount = enriched.filter(d => d.light === "yellow").length;
      const redCount = enriched.filter(d => d.light === "red").length;

      statGreen.textContent = `${greenCount}`;
      statYellow.textContent = `${yellowCount}`;
      statRed.textContent = `${redCount}`;

      const top10 = [...enriched].sort((a,b)=>b.value-a.value).slice(0,10).reverse();
      const xMax = niceMax(Math.max(...top10.map(d => d.value)));

      // åœ“é»ç‡ˆè™Ÿï¼šç”¨ value
      const lightPoints = enriched
        .filter(d => !EXCLUDE_COUNTIES.has(d.name))
        .map(d => {
          const coord = getCountyCoord(d.name);
          if (!coord) return null;
          return {
            name: d.name,
            value: [coord[0], coord[1], d.value],
            light: d.light,
            metricValue: d.value
          };
        })
        .filter(Boolean);

      // ç´…ç‡ˆæ¸…å–®ï¼šé¡¯ç¤º value
      const redItems = enriched
        .filter(d => d.light === "red")
        .sort((a,b)=> b.value - a.value);

      redList.innerHTML = "";
      if (!redItems.length) {
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡ç´…ç‡ˆç¸£å¸‚</li>`;
      } else {
        redItems.forEach(d => {
          const li = document.createElement('li');
          li.className = "red-item" + (d.name === selectedCounty ? " active" : "");
          li.setAttribute("data-county", d.name);
          li.innerHTML = `<span>${d.name}</span><span>${d.value.toFixed(1)}</span>`;
          li.addEventListener('click', () => selectCounty(d.name));
          redList.appendChild(li);
        });
      }

      // åœ°åœ–
      const mapOption = {
        backgroundColor: 'transparent',
        geo: {
          map: 'taiwan',
          roam: true,
          boundingCoords: MAIN_ISLAND_BBOX || null,
          layoutCenter: ['50%', '54%'],
          layoutSize: '98%',
          top: 44, bottom: 10, left: 10, right: 64,
          aspectScale: 0.8,
          nameProperty: 'COUNTYNAME',
          itemStyle: { borderColor: 'rgba(148,163,184,.55)', borderWidth: 0.8 },
          emphasis: {
            label: { show: true, color: '#0b1220', fontWeight: 800 },
            itemStyle: { borderColor: '#0b1220', borderWidth: 1.5, shadowColor: 'rgba(2,6,23,.35)', shadowBlur: 14 }
          }
        },

        tooltip: {
          trigger: 'item',
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const countyName = params.name;
            const item = enriched.find(x => x.name === countyName);
            if (!item) return `<div style="font-weight:800">${countyName}</div><div>ç„¡è³‡æ–™</div>`;

            const lt = lightText(item.light);
            const lc = lightColor(item.light);

            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px;">
                  <div style="font-weight:900;color:#0b1220;font-size:14px">${countyName}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;line-height:1.45;font-size:12px">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${Number(item.value).toFixed(1)}</b> åˆ†</div>
                  <div style="margin-top:6px;color:#64748b;">ç‡ˆè™Ÿç”±åŒä¸€æŒ‡æ¨™åˆ†æ•¸ä¾é–€æª»åˆ¤å®š</div>
                </div>
              </div>
            `;
          }
        },

        visualMap: {
          type: 'continuous',
          show: true,
          seriesIndex: 0,
          dimension: 0,
          min: Math.min(...values),
          max: Math.max(...values),
          orient: 'vertical',
          right: 12,
          top: 74,
          bottom: 18,
          itemWidth: 12,
          itemHeight: 280,
          calculable: true,
          realtime: true,
          text: ['é«˜', 'ä½'],
          textGap: 8,
          textStyle: { color: '#334155', fontWeight: 800, fontSize: 12 },
          handleSize: 18,
          handleStyle: { color: '#334155', borderColor: '#0f172a', borderWidth: 1 },
          inRange: { color: ['#eef2ff', '#c7d2fe', '#818cf8', '#312e81'] },
          backgroundColor: 'transparent',
          borderWidth: 0,
          padding: 0
        },

        series: [
          {
            name: metricText,
            type: 'map',
            geoIndex: 0,
            map: 'taiwan',
            roam: false,
            nameProperty: 'COUNTYNAME',
            data: enriched.map(d => ({ name: d.name, value: d.value }))
          },
          {
            name: 'ç‡ˆè™Ÿ',
            type: 'scatter',
            coordinateSystem: 'geo',
            zlevel: 3,
            symbol: 'circle',
            symbolSize: 12,
            data: lightPoints,
            tooltip: { show: false },
            itemStyle: {
              color: (p) => lightColor(p.data.light),
              borderColor: 'rgba(15,23,42,.92)',
              borderWidth: 1.2,
              shadowBlur: 12,
              shadowColor: 'rgba(2,6,23,.25)',
              opacity: 0.95
            },
            emphasis: { scale: true }
          }
        ]
      };
      mapChart.setOption(mapOption, true);

      // Top10ï¼šåƒè€ƒåœ–æ¨£å¼ï¼ˆè‡ªå‹• maxï¼‰
      const barOption = {
        backgroundColor: 'transparent',
        grid: { left: 88, right: 34, top: 10, bottom: 26 },
        xAxis: {
          type: 'value',
          min: 0,
          max: xMax,
          axisLine: { show: false },
          axisTick: { show: false },
          axisLabel: { color: '#6b7280', fontWeight: 700 },
          splitLine: {
            show: true,
            lineStyle: { type: 'dashed', color: 'rgba(148,163,184,.35)' }
          }
        },
        yAxis: {
          type: 'category',
          data: top10.map(d => d.name),
          axisLine: { show: true, lineStyle: { color: 'rgba(148,163,184,.55)' } },
          axisTick: { show: true, length: 6, lineStyle: { color: 'rgba(148,163,184,.55)' } },
          axisLabel: { color: '#374151', fontWeight: 800, fontSize: 12 }
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'none' },
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const p = params[0];
            const item = top10.find(d => d.name === p.name);
            if (!item) return '';
            const lt = lightText(item.light);
            const lc = lightColor(item.light);
            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
                  <div style="font-weight:900;color:#0b1220">${item.name}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;font-size:12px;line-height:1.45">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${item.value.toFixed(1)}</b> åˆ†</div>
                </div>
              </div>
            `;
          }
        },
        series: [
          {
            type: 'bar',
            barWidth: 18,
            itemStyle: {
              color: (p) => {
                // Top10 å¯ä»¥ä¾ç‡ˆè™Ÿè‘—è‰²ï¼ˆæ›´ä¸€è‡´ï¼‰
                const v = Number(p.value);
                const light = getLight(metric, v);
                return lightColor(light);
              },
              borderRadius: [999, 999, 999, 999]
            },
            emphasis: { itemStyle: { opacity: 0.92 } },
            data: top10.map(d => d.value),
            label: {
              show: true,
              position: 'right',
              distance: 6,
              color: '#111827',
              fontWeight: 800,
              formatter: (p) => Number(p.value).toFixed(1)
            }
          }
        ]
      };
      barChart.setOption(barOption, true);

      // ä¿ç•™é¸å–ï¼ˆè‹¥ä»å­˜åœ¨ï¼‰
      if (selectedCounty) {
        const exists = enriched.some(d => d.name === selectedCounty);
        if (exists) {
          highlightOnMap(selectedCounty);
          highlightRedList(selectedCounty);
          updateSelectedSummary(enriched.find(d => d.name === selectedCounty));
        } else {
          selectedCounty = null;
          updateSelectedSummary(null);
        }
      } else {
        updateSelectedSummary(null);
      }
    }

    window.addEventListener('resize', () => {
      mapChart.resize();
      barChart.resize();
    });
  </script>
</body>
</html>
