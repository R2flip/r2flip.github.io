<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆå«é è­¦ç‡ˆè™Ÿï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ECharts + TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

/* =========================================================
   Base & Theme
========================================================= */
*{ box-sizing:border-box; margin:0; padding:0; }

:root{
  --bg1:#0b1220;
  --bg2:#0f172a;

  --card: rgba(255,255,255,.92);
  --text:#0f172a;
  --muted:#6b7280;

  /* é è­¦ç‡ˆè™Ÿ */
  --green:#22c55e;
  --yellow:#fbbf24;
  --red:#ef4444;

  --radius:18px;
  --shadow:0 12px 30px rgba(2,6,23,.18);
  --shadow-soft:0 10px 24px rgba(2,6,23,.14);
  --ring:0 0 0 3px rgba(59,130,246,.2);
}

body{
  font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  color:#e5e7eb;

  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(37,99,235,.35), transparent 55%),
    radial-gradient(1000px 550px at 100% 0%, rgba(236,72,153,.25), transparent 55%),
    radial-gradient(900px 500px at 50% 110%, rgba(34,197,94,.18), transparent 55%),
    linear-gradient(180deg,#0b1020,#0b1220 40%,#0b1220);
}

/* =========================================================
   Header
========================================================= */
header{
  position:sticky;
  top:0;
  z-index:10;

  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:18px;

  padding:18px 22px;
  border-bottom:1px solid rgba(148,163,184,.16);
  backdrop-filter: blur(10px);

  background: linear-gradient(
    90deg,
    rgba(15,23,42,.7),
    rgba(37,99,235,.25),
    rgba(236,72,153,.18)
  );
}

header h1{
  font-size:1.25rem;
  font-weight:800;
  letter-spacing:.06em;
}

header .subtitle{
  font-size:.92rem;
  color:rgba(226,232,240,.9);
}

.meta-right{
  text-align:right;
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:.9rem;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(148,163,184,.18);
  box-shadow:0 8px 22px rgba(2,6,23,.15);
}

/* =========================================================
   Layout
========================================================= */
main.layout{
  flex:1;
  display:grid;
  grid-template-columns:minmax(640px,1fr) 360px;
  gap:16px;
  padding:16px 18px 18px;
  align-items:start;
}

/* =========================================================
   Card System
========================================================= */
.card{
  position:relative;
  background:var(--card);
  color:var(--text);
  border-radius:var(--radius);
  border:1px solid rgba(148,163,184,.22);
  box-shadow:var(--shadow);
  overflow:hidden;
}

.card::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(500px 300px at 15% 0%, rgba(37,99,235,.10), transparent 60%),
    radial-gradient(450px 260px at 100% 0%, rgba(236,72,153,.08), transparent 60%);
  pointer-events:none;
}

.card-header{
  padding:12px 14px;
  border-bottom:1px solid rgba(148,163,184,.16);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
  z-index:1;
}

.card-title{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:1rem;
  font-weight:900;
}

.card-body{
  padding:12px 14px 14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position:relative;
  z-index:1;
}

/* =========================================================
   Map Panel
========================================================= */
.map-panel{
  display:flex;
  flex-direction:column;
}

#mapContainer{
  flex:1;
  min-height:560px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.25);
  background:linear-gradient(180deg,rgba(219,234,254,.9),rgba(243,244,246,.9));
}

/* =========================================================
   Right Control Panel (Single Scroll Source)
========================================================= */
.control-panel{
  position:sticky;
  top:92px;

  height:calc(100dvh - 110px);
  overflow-y:auto;
  overflow-x:hidden;

  display:flex;
  flex-direction:column;
  gap:12px;
  padding-right:8px;

  overscroll-behavior:contain;
}

.control-panel > .card{
  flex:0 0 auto;
  box-shadow:var(--shadow-soft);
}

/* =========================================================
   Controls
========================================================= */
.controls{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.control-group{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.control-label{
  font-size:.78rem;
  font-weight:800;
  color:#475569;
}

select{
  padding:9px 12px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.35);
  background:rgba(255,255,255,.92);
  font-size:.92rem;
}

select:focus{
  border-color:rgba(37,99,235,.8);
  box-shadow:var(--ring);
}

/* =========================================================
   KPI / Threshold
========================================================= */
.thresholds{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.pill,.kpi{
  padding:10px 12px;
  border-radius:14px;
  background:rgba(255,255,255,.8);
  border:1px solid rgba(148,163,184,.22);
}

.kpi-row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.kpi3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
}

.kpi .k{
  font-size:.74rem;
  font-weight:900;
  color:#475569;
}

.kpi .v{
  font-size:1.05rem;
  font-weight:950;
  color:#0b1220;
}

/* =========================================================
   Top10 Chart
========================================================= */
#barContainer{
  width:100%;
  height:240px;
  min-height:240px;
  border-radius:14px;
  background:rgba(249,250,251,.95);
  border:1px solid rgba(148,163,184,.25);
}

/* =========================================================
   Red List (No Inner Scroll)
========================================================= */
#redList{
  list-style:none;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.red-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:9px 12px;
  border-radius:16px;
  background:rgba(239,68,68,.08);
  border:1px solid rgba(239,68,68,.18);
  font-weight:900;
  color:#7f1d1d;
}

/* =========================================================
   Mobile
========================================================= */
@media (max-width:1100px){
  main.layout{ grid-template-columns:1fr; }

  .control-panel{
    position:static;
    height:auto;
    overflow:visible;
    padding-right:0;
  }

  #mapContainer{ min-height:460px; }
  #barContainer{ height:260px; min-height:260px; }
}




  
</head>

<body>
  <header>
    <div class="hgroup">
      <h1>è‡ºç£å„ç¸£å¸‚æ°£å€™ç„¦æ…®ç†±åŠ›åœ–å„€è¡¨æ¿ï¼ˆå«é è­¦ç‡ˆè™Ÿï¼‰</h1>
      <div class="subtitle">è³‡è¨Šåˆ†å±¤ï¼šä¸»è¦–è¦ºåœ°åœ– â†’ å³æ¬„æ±ºç­–æ‘˜è¦ï¼ˆæ¢ä»¶/æ‘˜è¦/Top10/ç´…ç‡ˆæ¸…å–®ï¼‰</div>
    </div>
    <div class="meta-right">
      <div class="badge"><span class="dot"></span>è³‡æ–™ä¾†æºï¼šTCCAS æ ¡åœ’èª¿æŸ¥ã€ç·šä¸Šå•å·ï¼ˆç¤ºç¯„è³‡æ–™ï¼‰</div>
      <div class="subtitle" id="currentMeta">å¹´åº¦ï¼šâ€”ã€€ï½œã€€æŒ‡æ¨™ï¼šâ€”</div>
    </div>
  </header>

  <main class="layout">
    <!-- å·¦å´ï¼šä¸»è¦–è¦ºåœ°åœ–å¡ -->
    <section class="card map-panel">
      <div class="card-header">
        <div class="card-title">
          å„ç¸£å¸‚ç†±åŠ›åœ– & é è­¦ç‡ˆè™Ÿ
          <span class="tag">ç¶  / é»ƒ / ç´…</span>
        </div>
        <div class="card-subtitle" id="mapSubtitle">
          ç†±åŠ›åœ–ï¼šæŒ‡æ¨™åˆ†æ•¸ï¼ˆvalueï¼‰<br/>
          åœ“é»ï¼šé è­¦ç‡ˆè™Ÿï¼ˆwarnï¼‰
        </div>
      </div>

      <div class="card-body">
        <div id="mapContainer"></div>
        <div class="legend-note">
          èªªæ˜ï¼šç†±åŠ›åœ–é¡è‰²è¡¨ç¤º<strong>æŒ‡æ¨™åˆ†æ•¸</strong>ï¼ˆä¸­æ€§è‰²éšé¿å…èˆ‡ç´…é»ƒç¶ æ··æ·†ï¼‰ï¼›åœ“é»é¡è‰²è¡¨ç¤º<strong>é è­¦ç‡ˆè™Ÿ</strong>ã€‚é»æ“Šç¸£å¸‚å¯åœ¨å³æ¬„è‡ªå‹•ç”Ÿæˆæ‘˜è¦ä¸¦å®šä½ç´…ç‡ˆæ¸…å–®ã€‚
        </div>
      </div>
    </section>

    <!-- å³å´ï¼šå›ºå®šè³‡è¨Šæ¬„ï¼ˆå¯æ²å‹•ï¼‰ -->
   <aside class="control-panel">

  <!-- 1) åˆ†ææ¢ä»¶ï¼ˆå« KPIï¼‰ -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span class="card-icon">âš™</span>
        åˆ†ææ¢ä»¶
      </div>
      <div class="card-subtitle">å¹´åº¦ / æŒ‡æ¨™ / é–€æª»</div>
    </div>

    <div class="card-body">
      <div class="controls">
        <div class="control-group">
          <label for="yearSelect" class="control-label">å¹´åº¦</label>
          <select id="yearSelect">
            <option value="2024" selected>2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
          </select>
        </div>

        <div class="control-group">
          <label for="metricSelect" class="control-label">æŒ‡æ¨™é¡å‹</label>
          <select id="metricSelect">
            <option value="mean_score" selected>å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
            <option value="high_risk_pct">ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
            <option value="severe_score">å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰</option>
          </select>
        </div>
      </div>

      <div class="thresholds">
        <div class="pill">
          <div class="p-title">
            ç¶ ç‡ˆé–€æª» <span class="light-chip chip-green">ç¶ </span>
          </div>
          <div class="p-desc" id="thGreen">â€”</div>
        </div>

        <div class="pill">
          <div class="p-title">
            é»ƒç‡ˆé–€æª» <span class="light-chip chip-yellow">é»ƒ</span>
          </div>
          <div class="p-desc" id="thYellow">â€”</div>
        </div>
      </div>

      <div class="pill">
        <div class="p-title">
          ç´…ç‡ˆæ¢ä»¶ <span class="light-chip chip-red">ç´…</span>
        </div>
        <div class="p-desc" id="thRed">â€”</div>
        <div class="footer-hint">â€» å¿ƒç†éŸŒæ€§ç‚ºåå‘ç‡ˆè™Ÿï¼ˆé«˜åˆ†â†’ç¶ ï¼‰</div>
      </div>

      <!-- KPIï¼šæ›´åƒå„€è¡¨æ¿ -->
      <div class="kpi-row">
        <div class="kpi">
          <div class="k">å…¨åœ‹å¹³å‡ï¼ˆæŒ‡æ¨™ï¼‰</div>
          <div class="v" id="statAvg">â€”</div>
        </div>
        <div class="kpi">
          <div class="k">æœ€é«˜ç¸£å¸‚ï¼ˆæŒ‡æ¨™ï¼‰</div>
          <div class="v" id="statMax">â€”</div>
        </div>
      </div>

      <div class="kpi3">
        <div class="kpi badge-green">
          <div class="k">ç¶ ç‡ˆæ•¸</div>
          <div class="v" id="statGreen">â€”</div>
        </div>
        <div class="kpi badge-yellow">
          <div class="k">é»ƒç‡ˆæ•¸</div>
          <div class="v" id="statYellow">â€”</div>
        </div>
        <div class="kpi badge-red">
          <div class="k">ç´…ç‡ˆæ•¸</div>
          <div class="v" id="statRed">â€”</div>
        </div>
      </div>
    </div>
  </section>

  <!-- 2) é¸å–æ‘˜è¦ -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span class="card-icon">ğŸ“Œ</span>
        é¸å–ç¸£å¸‚æ‘˜è¦
      </div>
      <div class="card-actions">
        <button id="copySummary" class="btn copy">è¤‡è£½æ‘˜è¦</button>
      </div>
    </div>

    <div class="card-body">
      <div class="sel-pill">
        <div class="sel-line">
          <div class="k">ç¸£å¸‚</div>
          <div class="sel-badge" id="selLight">â€”</div>
        </div>
        <div class="v" id="selName">å°šæœªé¸å–ï¼ˆé»åœ°åœ–æˆ–é»ç´…ç‡ˆæ¸…å–®ï¼‰</div>
      </div>

      <div class="sel-grid">
        <div class="sel-pill">
          <div class="k">æŒ‡æ¨™åˆ†æ•¸ï¼ˆvalueï¼‰</div>
          <div class="v" id="selValue">â€”</div>
        </div>
        <div class="sel-pill">
          <div class="k">é è­¦åˆ†æ•¸ï¼ˆwarnï¼‰</div>
          <div class="v" id="selWarn">â€”</div>
        </div>
      </div>

      <div class="sel-pill">
        <div class="k">æ”¿ç­–æ‘˜è¦å¥ï¼ˆå¯ç›´æ¥è²¼å ±å‘Šï¼‰</div>
        <div class="v" id="selSentence" style="font-size:.9rem; line-height:1.35; font-weight:950; color:#0f172a;">â€”</div>
      </div>
    </div>
  </section>

  <!-- 3) Top10 -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span class="card-icon">ğŸ“Š</span>
        Top 10 ç¸£å¸‚æ¯”è¼ƒ
      </div>
      <div class="card-subtitle" id="barTitle">â€”</div>
    </div>

    <div class="card-body">
      <div id="barContainer"></div>
      <div class="legend-note">
        æ¢åœ–é¡è‰²ä¾ã€Œé è­¦ç‡ˆè™Ÿã€è‘—è‰²ï¼šç¶ ï¼é»ƒï¼ç´…ï¼ˆä»¥é è­¦åˆ†æ•¸åˆ¤æ–·ï¼‰ã€‚
      </div>
    </div>
  </section>

  <!-- 4) ç´…ç‡ˆæ¸…å–® + CSV -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">
        <span class="card-icon" style="background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.20);color:#b91c1c;">ğŸ”´</span>
        ç´…ç‡ˆç¸£å¸‚æ¸…å–®
      </div>
      <div class="card-actions">
        <button id="downloadCSV" class="btn red">ä¸‹è¼‰ CSV</button>
      </div>
    </div>

    <div class="card-body">
      <ul id="redList"></ul>
      <div class="legend-note">â€» ä¾ã€Œé è­¦åˆ†æ•¸ã€èˆ‡é–€æª»åˆ¤å®šï¼ˆå¿ƒç†éŸŒæ€§ç‚ºåå‘ç‡ˆè™Ÿï¼‰</div>
    </div>
  </section>

</aside>

  </main>

  <script>
    // =========================
    // 0) æª”æ¡ˆè¨­å®š
    // =========================
    const TOPO_URL = 'twCounty_22counties_topo.json';

    // =========================
    // 1) æ¨¡æ“¬è³‡æ–™ï¼ˆç¤ºç¯„ï¼‰
    // =========================
    const climateAnxietyData = {
      "2024": {
        "mean_score": [
          { name: "å°åŒ—å¸‚", value: 78, warn: 80 },
          { name: "æ–°åŒ—å¸‚", value: 72, warn: 73 },
          { name: "æ¡ƒåœ’å¸‚", value: 70, warn: 69 },
          { name: "å°ä¸­å¸‚", value: 69, warn: 68 },
          { name: "å°å—å¸‚", value: 65, warn: 64 },
          { name: "é«˜é›„å¸‚", value: 75, warn: 77 },
          { name: "åŸºéš†å¸‚", value: 68, warn: 70 },
          { name: "æ–°ç«¹å¸‚", value: 80, warn: 83 },
          { name: "å˜‰ç¾©å¸‚", value: 66, warn: 65 },
          { name: "æ–°ç«¹ç¸£", value: 77, warn: 79 },
          { name: "è‹—æ —ç¸£", value: 62, warn: 60 },
          { name: "å½°åŒ–ç¸£", value: 60, warn: 59 },
          { name: "å—æŠ•ç¸£", value: 63, warn: 61 },
          { name: "é›²æ—ç¸£", value: 58, warn: 57 },
          { name: "å˜‰ç¾©ç¸£", value: 59, warn: 58 },
          { name: "å±æ±ç¸£", value: 67, warn: 66 },
          { name: "å®œè˜­ç¸£", value: 71, warn: 72 },
          { name: "èŠ±è“®ç¸£", value: 69, warn: 70 },
          { name: "å°æ±ç¸£", value: 68, warn: 69 },
          { name: "æ¾æ¹–ç¸£", value: 61, warn: 60 },
          { name: "é‡‘é–€ç¸£", value: 55, warn: 54 },
          { name: "é€£æ±Ÿç¸£", value: 52, warn: 51 }
        ],
        "high_risk_pct": [
          { name: "å°åŒ—å¸‚", value: 26, warn: 27 },
          { name: "æ–°åŒ—å¸‚", value: 22, warn: 23 },
          { name: "é«˜é›„å¸‚", value: 24, warn: 25 },
          { name: "æ–°ç«¹å¸‚", value: 28, warn: 29 },
          { name: "æ–°ç«¹ç¸£", value: 25, warn: 26 },
          { name: "å°ä¸­å¸‚", value: 21, warn: 21 },
          { name: "å±æ±ç¸£", value: 20, warn: 20 },
          { name: "å®œè˜­ç¸£", value: 23, warn: 24 },
          { name: "èŠ±è“®ç¸£", value: 22, warn: 22 },
          { name: "å°æ±ç¸£", value: 21, warn: 21 },
          { name: "å°å—å¸‚", value: 19, warn: 19 },
          { name: "å˜‰ç¾©å¸‚", value: 18, warn: 18 }
        ],
        "severe_score": [
          { name: "å°åŒ—å¸‚", value: 84, warn: 82 },
          { name: "æ–°åŒ—å¸‚", value: 81, warn: 79 },
          { name: "æ¡ƒåœ’å¸‚", value: 79, warn: 77 },
          { name: "å°ä¸­å¸‚", value: 78, warn: 76 },
          { name: "é«˜é›„å¸‚", value: 85, warn: 83 },
          { name: "æ–°ç«¹å¸‚", value: 86, warn: 84 },
          { name: "æ–°ç«¹ç¸£", value: 83, warn: 81 },
          { name: "å±æ±ç¸£", value: 80, warn: 78 },
          { name: "å®œè˜­ç¸£", value: 82, warn: 80 },
          { name: "èŠ±è“®ç¸£", value: 81, warn: 79 },
          { name: "å°æ±ç¸£", value: 80, warn: 78 }
        ]
      },
      "2023": { "mean_score": [], "high_risk_pct": [], "severe_score": [] },
      "2022": { "mean_score": [], "high_risk_pct": [], "severe_score": [] }
    };

    // =========================
    // 2) é è­¦é–€æª»ï¼ˆå¿ƒç†éŸŒæ€§åå‘ï¼‰
    // =========================
    const warnThresholds = {
      mean_score:    { greenMax: 65, yellowMax: 75 },
      high_risk_pct: { greenMax: 20, yellowMax: 25 },
      severe_score:  { greenMax: 72, yellowMax: 82 }
    };

    function getLight(metric, warnScore){
      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };
      if (metric === "severe_score") {
        if (warnScore >= t.yellowMax) return "green";
        if (warnScore >= t.greenMax) return "yellow";
        return "red";
      }
      if (warnScore <= t.greenMax) return "green";
      if (warnScore <= t.yellowMax) return "yellow";
      return "red";
    }
    function lightText(light){
      return light === "green" ? "ç¶ ç‡ˆ" : light === "yellow" ? "é»ƒç‡ˆ" : "ç´…ç‡ˆ";
    }
    function lightColor(light){
      return light === "green" ? "#22c55e" : light === "yellow" ? "#fbbf24" : "#ef4444";
    }
    function metricLabel(metric){
      return ({
        mean_score: "å¹³å‡ TCCAS åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        high_risk_pct: "ç¤¾ç¾¤è²¼æ–‡æƒ…ç·’åˆ†æ•¸ï¼ˆ0â€“100ï¼‰",
        severe_score: "å¹³å‡å¿ƒç†éŸŒæ€§åˆ†æ•¸ï¼ˆ0â€“100ï¼‰"
      })[metric] || metric;
    }

    // =========================
    // 3) DOM + åœ–è¡¨
    // =========================
    const mapChart = echarts.init(document.getElementById('mapContainer'));
    const barChart = echarts.init(document.getElementById('barContainer'));

    const yearSelect = document.getElementById('yearSelect');
    const metricSelect = document.getElementById('metricSelect');

    const currentMeta = document.getElementById('currentMeta');
    const barTitle = document.getElementById('barTitle');

    const statAvg = document.getElementById('statAvg');
    const statMax = document.getElementById('statMax');
    const statGreen = document.getElementById('statGreen');
    const statYellow = document.getElementById('statYellow');
    const statRed = document.getElementById('statRed');

    const thGreen = document.getElementById('thGreen');
    const thYellow = document.getElementById('thYellow');
    const thRed = document.getElementById('thRed');

    const redList = document.getElementById('redList');
    const downloadCSV = document.getElementById('downloadCSV');

    const selName = document.getElementById('selName');
    const selLight = document.getElementById('selLight');
    const selValue = document.getElementById('selValue');
    const selWarn = document.getElementById('selWarn');
    const selSentence = document.getElementById('selSentence');
    const copySummary = document.getElementById('copySummary');

    let countyCentroid = new Map();
    let MAIN_ISLAND_BBOX = null;

    // âœ… é¸å–ç‹€æ…‹
    let selectedCounty = null;
    let lastEnriched = [];

    // =========================
    // 4) å¹¾ä½•ï¼šcentroid + æœ¬å³¶ bboxï¼ˆè‡ªå‹• fitï¼‰
    // =========================
    function centroidOfPolygon(coords){
      const ring = coords?.[0];
      if (!ring || ring.length < 3) return null;
      let area = 0, cx = 0, cy = 0;
      for (let i = 0; i < ring.length - 1; i++){
        const [x1,y1] = ring[i];
        const [x2,y2] = ring[i+1];
        const a = x1*y2 - x2*y1;
        area += a;
        cx += (x1 + x2) * a;
        cy += (y1 + y2) * a;
      }
      area *= 0.5;
      if (Math.abs(area) < 1e-10) return ring[0];
      cx /= (6*area);
      cy /= (6*area);
      return [cx, cy];
    }

    function centroidOfGeometry(geom){
      if (!geom) return null;
      if (geom.type === "Polygon") return centroidOfPolygon(geom.coordinates);
      if (geom.type === "MultiPolygon"){
        let best = null, bestArea = -Infinity;
        for (const poly of geom.coordinates){
          const ring = poly?.[0];
          if (!ring || ring.length < 3) continue;
          let area = 0;
          for (let i=0;i<ring.length-1;i++){
            const [x1,y1]=ring[i], [x2,y2]=ring[i+1];
            area += (x1*y2 - x2*y1);
          }
          const absA = Math.abs(area * 0.5);
          if (absA > bestArea){
            bestArea = absA;
            best = centroidOfPolygon(poly);
          }
        }
        return best;
      }
      return null;
    }

    function buildCentroids(geoJson){
      countyCentroid.clear();
      for (const f of geoJson.features || []){
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        const c = centroidOfGeometry(f.geometry);
        if (name && c) countyCentroid.set(name, c);
      }
    }
    function getCountyCoord(name){ return countyCentroid.get(name) || null; }

    const EXCLUDE_COUNTIES = new Set(["æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"]);

    function expandBbox(b, x, y) {
      if (!b) return { minX: x, minY: y, maxX: x, maxY: y };
      return {
        minX: Math.min(b.minX, x),
        minY: Math.min(b.minY, y),
        maxX: Math.max(b.maxX, x),
        maxY: Math.max(b.maxY, y)
      };
    }
    function bboxOfCoords(coords, bbox) {
      if (!coords) return bbox;
      if (typeof coords[0] === "number") return expandBbox(bbox, coords[0], coords[1]);
      for (const c of coords) bbox = bboxOfCoords(c, bbox);
      return bbox;
    }
    function computeMainIslandBoundingCoords(geoJson) {
      let bbox = null;
      for (const f of (geoJson.features || [])) {
        const name = f.properties?.COUNTYNAME || f.properties?.name;
        if (EXCLUDE_COUNTIES.has(name)) continue;
        bbox = bboxOfCoords(f.geometry?.coordinates, bbox);
      }
      if (!bbox) return null;
      return [[bbox.minX, bbox.minY], [bbox.maxX, bbox.maxY]];
    }

    // =========================
    // 5) é¸å–äº’å‹•ï¼šåœ°åœ–é«˜äº® + æ¸…å–®å®šä½ + æ‘˜è¦æ›´æ–°
    // =========================
    function highlightOnMap(name){
      try{
        if (selectedCounty) {
          mapChart.dispatchAction({ type: 'downplay', seriesIndex: 0, name: selectedCounty });
        }
        mapChart.dispatchAction({ type: 'highlight', seriesIndex: 0, name });
        mapChart.dispatchAction({ type: 'showTip', seriesIndex: 0, name });
      }catch(e){}
    }

    function highlightRedList(name){
      const el = redList.querySelector(`li[data-county="${name}"]`);
      redList.querySelectorAll('.red-item.active').forEach(x => x.classList.remove('active'));
      if (el){
        el.classList.add('active');
        el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    function makePolicySentence({year, metricText, county, value, warnScore, light}){
      const lt = lightText(light);
      if (metricSelect.value === "severe_score"){
        if (light === "red"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œé¡¯ç¤ºå¿ƒç†éŸŒæ€§åä½ï¼Œå»ºè­°å„ªå…ˆé…ç½®å¿ƒç†æ”¯æŒèˆ‡éŸŒæ€§å¼·åŒ–è³‡æºã€‚`;
        }
        if (light === "yellow"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œå¿ƒç†éŸŒæ€§ä¸­ç­‰ï¼Œå»ºè­°æŒçºŒç›£æ¸¬ä¸¦åŠ å¼·ç¤¾å€/æ ¡åœ’éŸŒæ€§ä»‹å…¥ã€‚`;
        }
        return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œå¿ƒç†éŸŒæ€§è¡¨ç¾è‰¯å¥½ï¼Œå¯ä½œç‚ºæ¨å»£éŸŒæ€§ç­–ç•¥ä¹‹åƒè€ƒã€‚`;
      } else {
        if (light === "red"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œé¢¨éšªåé«˜ï¼Œå»ºè­°åˆ—å…¥å„ªå…ˆé—œæ³¨èˆ‡æ”¿ç­–ä»‹å…¥ç¸£å¸‚ã€‚`;
        }
        if (light === "yellow"){
          return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œå‘ˆç¾è­¦æˆ’å¾µå…†ï¼Œå»ºè­°åŠ å¼·å®£å°èˆ‡é é˜²æ€§æ”¯æŒã€‚`;
        }
        return `${year}å¹´ ${county}ã€Œ${metricText}ã€æŒ‡æ¨™åˆ†æ•¸ ${value.toFixed(1)}ã€é è­¦åˆ†æ•¸ ${warnScore.toFixed(1)}ï¼ˆ${lt}ï¼‰ï¼Œæ•´é«”é¢¨éšªè¼ƒä½ï¼Œå»ºè­°ç¶­æŒæ—¢æœ‰æ”¯æŒæ©Ÿåˆ¶ä¸¦æŒçºŒè¿½è¹¤ã€‚`;
      }
    }

    function updateSelectedSummary(item){
      if (!item){
        selName.textContent = "å°šæœªé¸å–ï¼ˆé»åœ°åœ–æˆ–é»ç´…ç‡ˆæ¸…å–®ï¼‰";
        selLight.textContent = "â€”";
        selLight.style.color = "#0f172a";
        selValue.textContent = "â€”";
        selWarn.textContent = "â€”";
        selSentence.textContent = "â€”";
        return;
      }

      const year = yearSelect.value;
      const metricText = metricLabel(metricSelect.value);

      selName.textContent = item.name;
      selValue.textContent = `${Number(item.value).toFixed(1)} åˆ†`;
      selWarn.textContent = `${Number(item.warnScore).toFixed(1)} åˆ†`;

      selLight.textContent = lightText(item.light);
      selLight.style.color = lightColor(item.light);

      selSentence.textContent = makePolicySentence({
        year,
        metricText,
        county: item.name,
        value: Number(item.value),
        warnScore: Number(item.warnScore),
        light: item.light
      });
    }

    function selectCounty(name){
      selectedCounty = name;
      highlightOnMap(name);
      highlightRedList(name);

      const item = lastEnriched.find(x => x.name === name) || null;
      updateSelectedSummary(item);
    }

    copySummary.addEventListener('click', async () => {
      const text = selSentence.textContent?.trim();
      if (!text || text === "â€”") return;
      try{
        await navigator.clipboard.writeText(text);
        copySummary.textContent = "å·²è¤‡è£½";
        setTimeout(()=> copySummary.textContent = "è¤‡è£½æ‘˜è¦", 900);
      }catch(e){
        alert("ç€è¦½å™¨æœªå…è¨±å‰ªè²¼ç°¿å­˜å–ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ‘˜è¦æ–‡å­—ã€‚");
      }
    });

    // =========================
    // 6) CSV ä¸‹è¼‰ï¼ˆç´…ç‡ˆç¸£å¸‚ï¼‰
    // =========================
    downloadCSV.addEventListener('click', () => {
      const year = yearSelect.value;
      const metric = metricSelect.value;
      const metricText = metricLabel(metric);

      const rows = [["å¹´åº¦","ç¸£å¸‚","æŒ‡æ¨™é¡å‹","æŒ‡æ¨™åˆ†æ•¸","é è­¦åˆ†æ•¸","ç‡ˆè™Ÿ"]];
      const raw = climateAnxietyData[year]?.[metric] || [];

      raw.forEach(d => {
        const warnScore = d.warn ?? d.value;
        const light = getLight(metric, warnScore);
        if (light === "red") rows.push([year, d.name, metricText, d.value, warnScore, "ç´…ç‡ˆ"]);
      });

      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${year}_${metric}_ç´…ç‡ˆç¸£å¸‚æ¸…å–®.csv`;
      a.click();

      URL.revokeObjectURL(url);
    });

    // =========================
    // 7) è¼‰å…¥åœ°åœ– + é¦–æ¬¡ç¹ªè£½
    // =========================
    fetch(TOPO_URL)
      .then(res => res.json())
      .then(topoData => {
        const objKey = topoData.objects && (topoData.objects.layer1 ? "layer1" : Object.keys(topoData.objects)[0]);
        const geo = topojson.feature(topoData, topoData.objects[objKey]);

        buildCentroids(geo);
        MAIN_ISLAND_BBOX = computeMainIslandBoundingCoords(geo);

        echarts.registerMap('taiwan', geo);
        updateCharts();
      })
      .catch(err => {
        console.error('è¼‰å…¥ TopoJSON å¤±æ•—ï¼š', err);
        alert('è«‹ç¢ºèª twCounty_22counties_topo.json è·¯å¾‘æ­£ç¢ºï¼Œä¸”ç”¨æœ¬æ©Ÿä¼ºæœå™¨é–‹å•Ÿã€‚');
      });

    yearSelect.addEventListener('change', updateCharts);
    metricSelect.addEventListener('change', updateCharts);

    // âœ… é»åœ°åœ–ï¼šé«˜äº®/tooltip/æ‘˜è¦/æ¸…å–®å®šä½
    mapChart.on('click', (params) => {
      if (!params || !params.name) return;
      selectCounty(params.name);
    });

    // =========================
    // 8) æ›´æ–°ä¸»å‡½å¼
    // =========================
    function updateCharts(){
      const year = yearSelect.value;
      const metric = metricSelect.value;

      const metricText = metricLabel(metric);
      currentMeta.textContent = `å¹´åº¦ï¼š${year}ã€€ï½œã€€æŒ‡æ¨™ï¼š${metricText}`;
      barTitle.textContent = `${year} å¹´ ${metricText} Top 10ï¼ˆç‡ˆè™Ÿä¾é è­¦åˆ†æ•¸ï¼‰`;

      const t = warnThresholds[metric] || { greenMax: 60, yellowMax: 75 };
      if (metric === "severe_score") {
        thGreen.textContent  = `é è­¦åˆ†æ•¸ â‰¥ ${t.yellowMax} â†’ ç¶ ç‡ˆï¼ˆéŸŒæ€§é«˜ï¼‰`;
        thYellow.textContent = `é è­¦åˆ†æ•¸ ${t.greenMax} ï½ ${t.yellowMax - 0.1} â†’ é»ƒç‡ˆï¼ˆä¸­ç­‰ï¼‰`;
        thRed.textContent    = `é è­¦åˆ†æ•¸ < ${t.greenMax} â†’ ç´…ç‡ˆï¼ˆéŸŒæ€§ä¸è¶³ï¼‰`;
      } else {
        thGreen.textContent  = `é è­¦åˆ†æ•¸ â‰¤ ${t.greenMax} â†’ ç¶ ç‡ˆï¼ˆä½é¢¨éšªï¼‰`;
        thYellow.textContent = `é è­¦åˆ†æ•¸ ${t.greenMax + 0.1} ï½ ${t.yellowMax} â†’ é»ƒç‡ˆï¼ˆæ³¨æ„ï¼‰`;
        thRed.textContent    = `é è­¦åˆ†æ•¸ > ${t.yellowMax} â†’ ç´…ç‡ˆï¼ˆé«˜é¢¨éšªï¼‰`;
      }

      const raw = climateAnxietyData[year]?.[metric] || [];
      if (!raw.length){
        mapChart.clear();
        barChart.clear();
        statAvg.textContent = 'ç„¡è³‡æ–™';
        statMax.textContent = 'ç„¡è³‡æ–™';
        statGreen.textContent = 'â€”';
        statYellow.textContent = 'â€”';
        statRed.textContent = 'â€”';
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡è³‡æ–™</li>`;
        lastEnriched = [];
        updateSelectedSummary(null);
        return;
      }

      const enriched = raw.map(d => {
        const warnScore = (d.warn ?? d.value);
        const light = getLight(metric, warnScore);
        return { ...d, warnScore, light };
      });
      lastEnriched = enriched;

      const values = enriched.map(d => d.value);
      const avg = values.reduce((a,b)=>a+b,0) / values.length;
      const maxVal = Math.max(...values);
      const maxItem = enriched.find(d => d.value === maxVal);

      statAvg.textContent = `${avg.toFixed(1)} åˆ†`;
      statMax.textContent = `${maxItem.name}ï¼š${maxItem.value.toFixed(1)} åˆ†`;

      const greenCount = enriched.filter(d => d.light === "green").length;
      const yellowCount = enriched.filter(d => d.light === "yellow").length;
      const redCount = enriched.filter(d => d.light === "red").length;

      statGreen.textContent = `${greenCount}`;
      statYellow.textContent = `${yellowCount}`;
      statRed.textContent = `${redCount}`;

      const top10 = [...enriched].sort((a,b)=>b.value-a.value).slice(0,10).reverse();

      const lightPoints = enriched
        .filter(d => !EXCLUDE_COUNTIES.has(d.name))
        .map(d => {
          const coord = getCountyCoord(d.name);
          if (!coord) return null;
          return {
            name: d.name,
            value: [coord[0], coord[1], d.warnScore],
            light: d.light,
            metricValue: d.value,
            warnScore: d.warnScore
          };
        })
        .filter(Boolean);

      // âœ… ç´…ç‡ˆæ¸…å–®
      const redItems = enriched.filter(d => d.light === "red").sort((a,b)=> b.warnScore - a.warnScore);
      redList.innerHTML = "";
      if (!redItems.length) {
        redList.innerHTML = `<li class="ok-item">ç›®å‰ç„¡ç´…ç‡ˆç¸£å¸‚</li>`;
      } else {
        redItems.forEach(d => {
          const li = document.createElement('li');
          li.className = "red-item" + (d.name === selectedCounty ? " active" : "");
          li.setAttribute("data-county", d.name);
          li.innerHTML = `<span>${d.name}</span><span>${d.warnScore.toFixed(1)}</span>`;
          li.addEventListener('click', () => selectCounty(d.name));
          redList.appendChild(li);
        });
      }

      const mapOption = {
        backgroundColor: 'transparent',
        geo: {
          map: 'taiwan',
          roam: true,

          // âœ… è‡ªå‹• fit å°ç£æœ¬å³¶ bboxï¼ˆæ’é™¤é›¢å³¶ï¼‰
          boundingCoords: MAIN_ISLAND_BBOX || null,
          layoutCenter: ['50%', '54%'],
          layoutSize: '98%',

          // âœ… å³å´ç•™ visualMap
          top: 44,
          bottom: 10,
          left: 10,
          right: 64,

          aspectScale: 0.8,
          nameProperty: 'COUNTYNAME',
          itemStyle: { borderColor: 'rgba(148,163,184,.55)', borderWidth: 0.8 },
          emphasis: {
            label: { show: true, color: '#0b1220', fontWeight: 800 },
            itemStyle: { borderColor: '#0b1220', borderWidth: 1.5, shadowColor: 'rgba(2,6,23,.35)', shadowBlur: 14 }
          }
        },

        tooltip: {
          trigger: 'item',
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const countyName = params.name;
            const item = enriched.find(x => x.name === countyName);
            if (!item) return `<div style="font-weight:800">${countyName}</div><div>ç„¡è³‡æ–™</div>`;

            const lt = lightText(item.light);
            const lc = lightColor(item.light);

            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px;">
                  <div style="font-weight:900;color:#0b1220;font-size:14px">${countyName}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;line-height:1.45;font-size:12px">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${Number(item.value).toFixed(1)}</b> åˆ†</div>
                  <div>é è­¦åˆ†æ•¸ï¼š<b>${Number(item.warnScore).toFixed(1)}</b> åˆ†</div>
                  <div style="margin-top:6px;color:#64748b;">æç¤ºï¼šç†±åŠ›åœ–=æŒ‡æ¨™åˆ†æ•¸ï¼›ç‡ˆè™Ÿ=é è­¦åˆ†æ•¸</div>
                </div>
              </div>
            `;
          }
        },

        visualMap: {
          type: 'continuous',
          show: true,
          seriesIndex: 0,
          dimension: 0,
          min: Math.min(...values),
          max: Math.max(...values),

          orient: 'vertical',
          right: 12,
          top: 74,
          bottom: 18,

          itemWidth: 12,
          itemHeight: 280,

          calculable: true,
          realtime: true,

          text: ['é«˜', 'ä½'],
          textGap: 8,
          textStyle: { color: '#334155', fontWeight: 800, fontSize: 12 },

          handleSize: 18,
          handleStyle: { color: '#334155', borderColor: '#0f172a', borderWidth: 1 },

          /* âœ… ä¸­æ€§è‰²éšï¼šé¿å…è·Ÿç´…é»ƒç¶ ç‡ˆæ··æ·† */
          inRange: { color: ['#eef2ff', '#c7d2fe', '#818cf8', '#312e81'] },

          backgroundColor: 'transparent',
          borderWidth: 0,
          padding: 0
        },

        series: [
          {
            name: metricText,
            type: 'map',
            geoIndex: 0,
            map: 'taiwan',
            roam: false,
            nameProperty: 'COUNTYNAME',
            data: enriched.map(d => ({ name: d.name, value: d.value }))
          },
          {
            name: 'é è­¦ç‡ˆè™Ÿ',
            type: 'scatter',
            coordinateSystem: 'geo',
            zlevel: 3,
            symbol: 'circle',
            symbolSize: 12,
            data: lightPoints,
            tooltip: { show: false },
            itemStyle: {
              color: (p) => lightColor(p.data.light),
              borderColor: 'rgba(15,23,42,.92)',
              borderWidth: 1.2,
              shadowBlur: 12,
              shadowColor: 'rgba(2,6,23,.25)',
              opacity: 0.95
            },
            emphasis: { scale: true }
          }
        ]
      };
      mapChart.setOption(mapOption, true);

      const barOption = {
        backgroundColor: 'transparent',
        grid: { left: 110, right: 18, top: 18, bottom: 24 },
        xAxis: {
          type: 'value',
          axisLabel: { color: '#475569', fontWeight: 700 },
          splitLine: { show: true, lineStyle: { type: 'dashed', color: 'rgba(148,163,184,.45)' } }
        },
        yAxis: {
          type: 'category',
          data: top10.map(d => d.name),
          axisLabel: { color: '#334155', fontWeight: 900, fontSize: 12 }
        },
        tooltip: {
          trigger: 'axis',
          axisPointer: { type: 'shadow' },
          extraCssText: 'border-radius:14px; box-shadow:0 18px 45px rgba(2,6,23,.25);',
          formatter: (params) => {
            const p = params[0];
            const item = top10.find(d => d.name === p.name);
            if (!item) return '';
            const lt = lightText(item.light);
            const lc = lightColor(item.light);
            return `
              <div style="min-width:220px">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
                  <div style="font-weight:900;color:#0b1220">${item.name}</div>
                  <div style="font-weight:900;color:${lc};background:rgba(255,255,255,.90);border:1px solid rgba(148,163,184,.35);padding:3px 10px;border-radius:999px;">
                    ${lt}
                  </div>
                </div>
                <div style="color:#334155;font-size:12px;line-height:1.45">
                  <div>æŒ‡æ¨™åˆ†æ•¸ï¼š<b>${item.value.toFixed(1)}</b> åˆ†</div>
                  <div>é è­¦åˆ†æ•¸ï¼š<b>${item.warnScore.toFixed(1)}</b> åˆ†</div>
                </div>
              </div>
            `;
          }
        },
        series: [
          {
            type: 'bar',
            barWidth: 16,
            data: top10.map(d => ({
              value: d.value,
              itemStyle: { color: lightColor(d.light), borderRadius: [0, 10, 10, 0] }
            })),
            label: {
              show: true,
              position: 'right',
              color: '#0b1220',
              fontWeight: 950,
              formatter: (p) => Number(p.value).toFixed(1)
            }
          }
        ]
      };
      barChart.setOption(barOption, true);

      // âœ… ä¿ç•™é¸å–ï¼ˆè‹¥ä»å­˜åœ¨ï¼‰
      if (selectedCounty) {
        const exists = enriched.some(d => d.name === selectedCounty);
        if (exists) {
          highlightOnMap(selectedCounty);
          highlightRedList(selectedCounty);
          updateSelectedSummary(enriched.find(d => d.name === selectedCounty));
        } else {
          selectedCounty = null;
          updateSelectedSummary(null);
        }
      } else {
        updateSelectedSummary(null);
      }
    }

    window.addEventListener('resize', () => {
      mapChart.resize();
      barChart.resize();
    });
  </script>
</body>
</html>
