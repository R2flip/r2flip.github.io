<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨ˆç•«ç®¡ç†ç³»çµ±</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 20px; }
    h2 { color: #0066cc; }
    form, table { margin-top: 20px; }
    label { display: block; margin: 8px 0 4px; }
    input, select { width: 300px; padding: 6px; }
    button { margin-top: 12px; padding: 6px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #004999; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
  </style>
</head>
<body>

  <h2>æ–°å¢è¨ˆç•«è³‡æ–™</h2>
  <form id="projectForm">
    <label>è¨ˆç•«å¹´åº¦ <input type="text" name="è¨ˆç•«å¹´åº¦" required></label>
    <label>ç¶“è²»ä¾†æº <input type="text" name="ç¶“è²»ä¾†æº" required></label>
    <label>åŸ·è¡Œæ©Ÿæ§‹ <input type="text" name="åŸ·è¡Œæ©Ÿæ§‹" required></label>
    <label>åŸ·è¡Œå­¸ç³» <input type="text" name="åŸ·è¡Œå­¸ç³»" required></label>
    <label>ä¸»æŒäºº <input type="text" name="ä¸»æŒäºº" required></label>
    <label>æŒ¹æ³¨æ–¹æ¡ˆ <input type="text" name="æŒ¹æ³¨æ–¹æ¡ˆ"></label>
    <label>è¨ˆç•«æœŸç¨‹ <input type="text" name="è¨ˆç•«æœŸç¨‹"></label>
    <label>è£œåŠ©é‡‘é¡ <input type="number" name="è£œåŠ©é‡‘é¡"></label>
    <label>CoPI <input type="text" name="CoPI"></label>
    <button type="submit">æ–°å¢</button>
  </form>

  <h2>æŸ¥è©¢è¨ˆç•«è³‡æ–™</h2>
  <label>è¼¸å…¥å¹´åº¦ <input type="text" id="searchYear" placeholder="ä¾‹å¦‚ï¼š2025"></label>
  <button onclick="searchProjects()">æŸ¥è©¢</button>

  <table id="results">
    <thead>
      <tr>
        <th>è¨ˆç•«å¹´åº¦</th>
        <th>ç¶“è²»ä¾†æº</th>
        <th>åŸ·è¡Œæ©Ÿæ§‹</th>
        <th>åŸ·è¡Œå­¸ç³»</th>
        <th>ä¸»æŒäºº</th>
        <th>æŒ¹æ³¨æ–¹æ¡ˆ</th>
        <th>è¨ˆç•«æœŸç¨‹</th>
        <th>è£œåŠ©é‡‘é¡</th>
        <th>CoPI</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiUrl = "ğŸ‘‰è«‹æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€ğŸ‘ˆ";

    // æ–°å¢
    document.getElementById("projectForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const data = {};
      formData.forEach((v, k) => data[k] = v);

      fetch(apiUrl, { method: "POST", body: JSON.stringify(data) })
        .then(res => res.json())
        .then(() => { alert("æ–°å¢æˆåŠŸï¼"); this.reset(); searchProjects(); })
        .catch(() => alert("æ–°å¢å¤±æ•—ï¼"));
    });

    // æŸ¥è©¢
    function searchProjects() {
      const year = document.getElementById("searchYear").value.trim();
      let url = apiUrl;
      if (year) url += "?year=" + encodeURIComponent(year);

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#results tbody");
          tbody.innerHTML = "";
          data.forEach(item => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item["è¨ˆç•«å¹´åº¦"] || ""}</td>
              <td>${item["ç¶“è²»ä¾†æº"] || ""}</td>
              <td>${item["åŸ·è¡Œæ©Ÿæ§‹"] || ""}</td>
              <td>${item["åŸ·è¡Œå­¸ç³»"] || ""}</td>
              <td>${item["ä¸»æŒäºº"] || ""}</td>
              <td>${item["æŒ¹æ³¨æ–¹æ¡ˆ"] || ""}</td>
              <td>${item["è¨ˆç•«æœŸç¨‹"] || ""}</td>
              <td>${item["è£œåŠ©é‡‘é¡"] || ""}</td>
              <td>${item["CoPI"] || ""}</td>
              <td>
                <button class="btn-sm" onclick='editProject(${JSON.stringify(item)})'>ä¿®æ”¹</button>
                <button class="btn-sm" onclick='deleteProject("${item["è¨ˆç•«å¹´åº¦"]}","${item["ä¸»æŒäºº"]}")'>åˆªé™¤</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(() => alert("æŸ¥è©¢å¤±æ•—ï¼"));
    }

    // ä¿®æ”¹
    function editProject(item) {
      const newBudget = prompt("è¼¸å…¥æ–°çš„è£œåŠ©é‡‘é¡", item["è£œåŠ©é‡‘é¡"]);
      if (newBudget === null) return;

      item["è£œåŠ©é‡‘é¡"] = newBudget;
      fetch(apiUrl, { method: "PUT", body: JSON.stringify(item) })
        .then(res => res.json())
        .then(() => { alert("ä¿®æ”¹æˆåŠŸï¼"); searchProjects(); })
        .catch(() => alert("ä¿®æ”¹å¤±æ•—ï¼"));
    }

    // åˆªé™¤
    function deleteProject(year, host) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${year} å¹´åº¦ ${host} çš„è¨ˆç•«å—ï¼Ÿ`)) return;
      fetch(apiUrl, { method: "DELETE", body: JSON.stringify({ "è¨ˆç•«å¹´åº¦": year, "ä¸»æŒäºº": host }) })
        .then(res => res.json())
        .then(() => { alert("åˆªé™¤æˆåŠŸï¼"); searchProjects(); })
        .catch(() => alert("åˆªé™¤å¤±æ•—ï¼"));
    }
  </script>
</body>
</html>
